/**
 * éŸ³ä¹æ¨èç³»ç»Ÿä¸»JavaScriptæ–‡ä»¶
 * åŒ…å«Vue.jsåº”ç”¨åˆå§‹åŒ–å’Œæ ¸å¿ƒåŠŸèƒ½å®ç°
 */

// ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
  console.log('éŸ³ä¹æ¨èç³»ç»Ÿåº”ç”¨å·²åˆå§‹åŒ–');
  
  // å…¨å±€äº‹ä»¶æ€»çº¿ï¼Œç”¨äºç»„ä»¶é—´é€šä¿¡
  const EventBus = new Vue();
  
  // Vue.jsåº”ç”¨å®ä¾‹
  const app = new Vue({
    el: '#app',
    
    // æ•°æ®å±ï¿½?
    data: {
      // åº”ç”¨çŠ¶ï¿½?
      currentTab: 'welcome',
      isLoading: false,
      isLoadingRecommendations: false,
      currentLanguage: 'zh',
      isDeveloperMode: false,
      isRegistering: false,
      loginUsername: "",
      loginPassword: "",
      loginEmail: "",
      showLoginForm: true,
      showWelcomeOptions: false,
      showPreferencesSurvey: false,
      surveyCompleted: false,
      
      // ç”¨æˆ·ç›¸å…³
      username: '',
      email: '',
      password: '',
      loginErrorMessage: '',
      loginForm: {
        username: '',
        email: '',
        password: ''
      },
      
      // éŸ³ä¹åå¥½é€‰é¡¹
      musicGenres: [
        'æµè¡Œ', 'æ‘‡æ»š', 'å˜»å“ˆ', 'ç”µå­', 'çˆµå£«', 'å¤å…¸', 
        'R&B', 'ä¹¡æ‘', 'æ°‘è°£', 'é‡‘å±', 'è“è°ƒ', 'ä¸–ç•ŒéŸ³ä¹',
        'ç‹¬ç«‹', 'å®éªŒ', 'æ°›å›´', 'æœ‹å…‹', 'é›·é¬¼', 'çµé­‚',
        'æ”¾å…‹', 'è¿ªæ–¯ï¿?, 'å¸ƒé²ï¿?, 'æ‹‰ä¸', 'è‹±ä¼¦', 'å¦ç±»'
      ],
      selectedGenres: [],
      
      // æ¨èç®—æ³•è®¾ç½®
      recommendationAlgorithms: {
        hybrid: {
          name: 'æ··åˆæ¨è',
          description: 'ç»“åˆSVD++ã€NCFã€MLPç®—æ³•å’ŒååŒè¿‡æ»¤æä¾›æ›´å‡†ç¡®çš„æ¨ï¿?,
          selected: true
        },
        collaborative: {
          name: 'ååŒè¿‡æ»¤',
          description: 'åŸºäºç”¨æˆ·è¡Œä¸ºå’Œåå¥½çš„ç›¸ä¼¼æ€§æ¨èéŸ³ï¿?,
          selected: false
        },
        svdpp: {
          name: 'SVD++ç®—æ³•',
          description: 'åŸºäºçŸ©é˜µåˆ†è§£çš„æ¨èç®—ï¿?,
          selected: false
        },
        content: {
          name: 'å†…å®¹æ¨è',
          description: 'åŸºäºéŸ³ä¹ç‰¹å¾æ¨èç›¸ä¼¼é£æ ¼çš„æ­Œï¿?,
          selected: false
        }
      },
      
      // éŸ³ä¹è°ƒæŸ¥é—®å·
      surveyQuestions: [
        {
          id: 'music_genres',
          question: 'æ‚¨å–œæ¬¢å“ªäº›éŸ³ä¹ç±»å‹ï¼Ÿ',
          type: 'multiple',
          options: [], // å°†åœ¨åˆå§‹åŒ–æ—¶å¡«å……
          answer: []
        },
        {
          id: 'listening_frequency',
          question: 'æ‚¨å¤šä¹…å¬ä¸€æ¬¡éŸ³ä¹ï¼Ÿ',
          type: 'single',
          options: ['æ¯å¤©', 'æ¯å‘¨å‡ æ¬¡', 'å¶å°”', 'å¾ˆå°‘'],
          answer: ''
        },
        {
          id: 'preferred_era',
          question: 'æ‚¨åå¥½å“ªä¸ªå¹´ä»£çš„éŸ³ä¹ï¿?,
          type: 'multiple',
          options: ['60å¹´ä»£', '70å¹´ä»£', '80å¹´ä»£', '90å¹´ä»£', '2000å¹´ä»£', '2010å¹´ä»£', '2020å¹´ä»£'],
          answer: []
        },
        {
          id: 'mood_preference',
          question: 'æ‚¨é€šå¸¸åœ¨ä»€ä¹ˆå¿ƒæƒ…ä¸‹å¬éŸ³ä¹ï¼Ÿ',
          type: 'multiple',
          options: ['æ”¾æ¾ï¿?, 'å·¥ä½œ/å­¦ä¹ ï¿?, 'è¿åŠ¨ï¿?, 'ç¤¾äº¤ï¿?, 'ä¼¤å¿ƒï¿?, 'å¼€å¿ƒæ—¶'],
          answer: []
        },
        {
          id: 'discovery_preference',
          question: 'æ‚¨æ›´å–œæ¬¢å‘ç°æ–°éŸ³ä¹è¿˜æ˜¯å¬ç†Ÿæ‚‰çš„æ­Œæ›²ï¼Ÿ',
          type: 'single',
          options: ['æ€»æ˜¯å¯»æ‰¾æ–°éŸ³ï¿?, 'å¶å°”å°è¯•æ–°éŸ³ï¿?, 'ä¸»è¦å¬ç†Ÿæ‚‰çš„æ­Œæ›²', 'åªå¬æˆ‘å·²çŸ¥çš„æ­Œæ›²'],
          answer: ''
        }
      ],
      
      // ç®¡ç†å‘˜åŠŸèƒ½ç›¸ï¿?
      allUsers: [],
      newUser: {
        username: '',
        email: '',
        password: '',
        isDeveloper: false
      },
      editingUser: null,
      
      // å†…å®¹å¯¹è±¡ - ä¿®å¤æ¨¡æ¿ä¸­ä½¿ç”¨çš„contentå¯¹è±¡
      content: {
        welcome: {
          title: 'æ¬¢è¿ä½¿ç”¨éŸ³ä¹æ¨èç³»ç»Ÿ',
          subtitle: 'é€‰æ‹©ä¸‹é¢çš„é€‰é¡¹å¼€å§‹æ‚¨çš„éŸ³ä¹ä¹‹ï¿?,
          talkToAI: 'ä¸AIéŸ³ä¹åŠ©æ‰‹èŠå¤©',
          talkToAIDesc: 'å‘AIåŠ©æ‰‹è¯¢é—®éŸ³ä¹æ¨èã€è‰ºæœ¯å®¶ä¿¡æ¯æˆ–è¡¨è¾¾æ‚¨çš„æƒ…ç»ªï¼Œè·å–ä¸ªæ€§åŒ–éŸ³ä¹å»ºè®®',
          fillQuestionnaire: 'å¡«å†™éŸ³ä¹é—®å·',
          fillQuestionnaireDesc: 'é€šè¿‡å¯¹æ­Œæ›²è¯„åˆ†ï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„éŸ³ä¹åå¥½ï¼Œè·å–æ›´ç²¾å‡†çš„æ¨ï¿?
        },
        rate: {
          title: 'å¯¹æ­Œæ›²è¯„ï¿?,
          subtitle: 'è¯·å¯¹ä»¥ä¸‹æ­Œæ›²è¿›è¡Œè¯„åˆ†ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„éŸ³ä¹å“å‘³',
          notRated: 'æœªè¯„ï¿?,
          continueButton: 'è·å–æ¨è',
          needMoreRatings: 'è¯·è‡³å°‘å¯¹5é¦–æ­Œæ›²è¯„ï¿?
        },
        recommend: {
          title: 'ä¸ªæ€§åŒ–æ¨è',
          subtitle: 'æ ¹æ®æ‚¨çš„è¯„åˆ†ï¼Œæˆ‘ä»¬æ¨èä»¥ä¸‹æ­Œï¿?,
          loading: 'æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæ¨è...',
          noRecommendations: 'æš‚æ— æ¨èï¼Œè¯·å…ˆè¯„åˆ†æ›´å¤šæ­Œï¿?,
          rateMore: 'è¿”å›è¯„åˆ†æ›´å¤šæ­Œæ›²'
        },
        chat: {
          title: 'AIéŸ³ä¹åŠ©æ‰‹',
          subtitle: 'ä¸AIåŠ©æ‰‹äº¤æµï¼Œè·å–éŸ³ä¹æ¨èå’Œä¿¡æ¯',
          welcome: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIéŸ³ä¹åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æ‰¾æ­Œæ›²ã€äº†è§£è‰ºæœ¯å®¶ã€è·å–æ¨èï¼Œæˆ–è€…å›ç­”éŸ³ä¹ç›¸å…³é—®é¢˜ã€‚è¯·éšæ—¶å‘æˆ‘æé—®ï¿?,
          inputPlaceholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¦ï¿?..'
        },
        evaluate: {
          title: 'ç³»ç»Ÿè¯„ä¼°',
          subtitle: 'è¯·å¯¹æ¨èç³»ç»Ÿè¿›è¡Œè¯„ä»·ï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹ï¿?,
          submit: 'æäº¤è¯„ä¼°',
          thanks: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¿?,
          select: 'è¯·é€‰æ‹©',
          rating: {
            veryDissatisfied: 'éå¸¸ä¸æ»¡ï¿?,
            dissatisfied: 'ä¸æ»¡ï¿?,
            neutral: 'ä¸€ï¿?,
            satisfied: 'æ»¡æ„',
            verySatisfied: 'éå¸¸æ»¡æ„'
          },
          feedback: 'å…¶ä»–å»ºè®®æˆ–æ„ï¿?,
          feedbackPlaceholder: 'è¯·è¾“å…¥æ‚¨çš„å»ºè®®æˆ–æ„è§...',
          submitButton: 'æäº¤è¯„ä»·',
          thankYou: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¿?
        },
        header: {
          title: 'æ¬¢è¿ï¿?,
          subtitle: 'æ¢ç´¢æ‚¨çš„ä¸“å±éŸ³ä¹ä¸–ç•Œ',
          logout: 'é€€ï¿?
        },
        tabs: {
          welcome: 'æ¬¢è¿',
          rate: 'è¯„åˆ†',
          recommend: 'æ¨è',
          chat: 'èŠå¤©',
          evaluate: 'è¯„ä¼°'
        },
        footer: {
          title: 'éŸ³ä¹æ¨èç³»ç»Ÿ',
          description: 'ä¸€ä¸ªåŸºäºAIçš„ä¸ªæ€§åŒ–éŸ³ä¹æ¨èç³»ç»Ÿ'
        },
        errors: {
          emptyUsername: 'è¯·è¾“å…¥ç”¨æˆ·å',
          loginFailed: 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ï¿?
        },
        success: {
          login: 'ç™»å½•æˆåŠŸï¿?
        }
      },
      
      // ç¿»è¯‘å¯¹è±¡
      translationsZh: {
        welcome: 'æ¬¢è¿ä½¿ç”¨éŸ³ä¹æ¨èç³»ç»Ÿ',
        description: 'æ¢ç´¢ä¸ªæ€§åŒ–éŸ³ä¹æ¨è',
        login: 'ç™»å½•',
        register: 'æ³¨å†Œ',
        userId: 'ç”¨æˆ·ID',
        username: 'ç”¨æˆ·ï¿?,
        password: 'å¯†ç ',
        submit: 'æäº¤',
        cancel: 'å–æ¶ˆ',
        rate: 'è¯„åˆ†',
        recommend: 'æ¨è',
        chat: 'èŠå¤©',
        evaluate: 'è¯„ä¼°',
        moreInfo: 'æ›´å¤šä¿¡æ¯',
        rateThisSong: 'ä¸ºè¿™é¦–æ­Œè¯„åˆ†',
        similar: 'ç›¸ä¼¼æ­Œæ›²',
        artist: 'è‰ºæœ¯ï¿?,
        album: 'ä¸“è¾‘',
        releaseDate: 'å‘è¡Œæ—¥æœŸ',
        popularity: 'æµè¡Œï¿?,
        listen: 'æ”¶å¬',
        chatWithAI: 'ä¸AIéŸ³ä¹åŠ©æ‰‹èŠå¤©',
        sendMessage: 'å‘é€æ¶ˆï¿?,
        typeMessage: 'è¾“å…¥æ¶ˆæ¯...',
        loading: 'åŠ è½½ï¿?..',
        error: 'å‡ºé”™ï¿?,
        retry: 'é‡è¯•',
        noResults: 'æ²¡æœ‰ç»“æœ',
        welcome_message: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIéŸ³ä¹åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æ‰¾æ­Œæ›²ã€äº†è§£è‰ºæœ¯å®¶ã€è·å–æ¨èï¼Œæˆ–è€…å›ç­”éŸ³ä¹ç›¸å…³é—®é¢˜ã€‚è¯·éšæ—¶å‘æˆ‘æé—®ï¿?,
        developer: 'å¼€å‘ï¿½?,
        logout: 'é€€å‡ºç™»ï¿?,
        enterUsername: 'è¯·è¾“å…¥ç”¨æˆ·å',
        enterEmail: 'è¯·è¾“å…¥é‚®ï¿?,
        enterPassword: 'è¯·è¾“å…¥å¯†ï¿?
      },
      translationsEn: {
        welcome: 'Welcome to Music Recommendation System',
        description: 'Explore personalized music recommendations',
        login: 'Login',
        register: 'Register',
        userId: 'User ID',
        username: 'Username',
        password: 'Password',
        submit: 'Submit',
        cancel: 'Cancel',
        rate: 'Rate',
        recommend: 'Recommend',
        chat: 'Chat',
        evaluate: 'Evaluate',
        moreInfo: 'More Info',
        rateThisSong: 'Rate this song',
        similar: 'Similar Songs',
        artist: 'Artist',
        album: 'Album',
        releaseDate: 'Release Date',
        popularity: 'Popularity',
        listen: 'Listen',
        chatWithAI: 'Chat with AI Music Assistant',
        sendMessage: 'Send Message',
        typeMessage: 'Type a message...',
        loading: 'Loading...',
        error: 'Error',
        retry: 'Retry',
        noResults: 'No Results',
        welcome_message: 'Hello! I am your AI music assistant. I can help you find songs, learn about artists, get recommendations, or answer music-related questions. Feel free to ask me anything!',
        developer: 'Developer',
        logout: 'Logout',
        welcome_title: 'Welcome to Music Recommendation System',
        welcome_subtitle: 'Choose an option below to start your music journey',
        welcome_talkToAI: 'Chat with AI Music Assistant',
        welcome_talkToAIDesc: 'Ask the AI assistant for music recommendations, artist information, or express your emotions for personalized music suggestions',
        welcome_fillQuestionnaire: 'Fill Music Questionnaire',
        welcome_fillQuestionnaireDesc: 'Rate songs to help us understand your music preferences and get more accurate recommendations'
      },
      
      // è¯„ä¼°é—®é¢˜
      evaluationQuestions: [
        { id: 'recommendation_quality', text: 'æ‚¨å¯¹ç³»ç»Ÿçš„æ¨èè´¨é‡æ»¡æ„å—ï¿? },
        { id: 'ui_experience', text: 'æ‚¨å¯¹ç³»ç»Ÿçš„ç”¨æˆ·ç•Œé¢ä½“éªŒæ»¡æ„å—ï¿? },
        { id: 'overall_satisfaction', text: 'æ‚¨å¯¹ç³»ç»Ÿçš„æ•´ä½“ä½“éªŒæ»¡æ„å—ï¿? }
      ],
      evaluationResponses: [],
      evaluationSubmitted: false,
      
      // ç”¨æˆ·ä¿¡æ¯
      user: {
        id: null,
        username: '',
        email: '',
        isLoggedIn: false,
        isDeveloper: false
      },
      
      // éŸ³ä¹æ•°æ®
      sampleSongs: [
        {
          track_id: '1',
          track_name: 'æ™´å¤©',
          artist_name: 'å‘¨æ°ï¿?,
          title: 'æ™´å¤©',
          artist: 'å‘¨æ°ï¿?,
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: '2',
          track_name: 'Shape of You',
          artist_name: 'Ed Sheeran',
          title: 'Shape of You',
          artist: 'Ed Sheeran',
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: '3',
          track_name: 'æ¼”å‘˜',
          artist_name: 'è–›ä¹‹ï¿?,
          title: 'æ¼”å‘˜',
          artist: 'è–›ä¹‹ï¿?,
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: '4',
          track_name: 'Uptown Funk',
          artist_name: 'Mark Ronson ft. Bruno Mars',
          title: 'Uptown Funk',
          artist: 'Mark Ronson ft. Bruno Mars',
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: '5',
          track_name: 'æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ï¿?,
          artist_name: 'åˆ˜æ˜ï¿?,
          title: 'æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ï¿?,
          artist: 'åˆ˜æ˜ï¿?,
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
      ],
      userRatings: {},
      recommendations: [
        {
          track_id: 'rec1',
          track_name: 'çˆ±æƒ…è½¬ç§»',
          artist_name: 'é™ˆå¥•ï¿?,
          title: 'çˆ±æƒ…è½¬ç§»',
          artist: 'é™ˆå¥•ï¿?,
          explanation: 'åŸºäºæ‚¨å¯¹å‘¨æ°ä¼¦çš„å–œå¥½æ¨è',
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: 'rec2',
          track_name: 'Thinking Out Loud',
          artist_name: 'Ed Sheeran',
          title: 'Thinking Out Loud',
          artist: 'Ed Sheeran',
          explanation: 'ä¸æ‚¨å–œæ¬¢ï¿?Shape of You é£æ ¼ç›¸ä¼¼',
          album_image: '/static/img/default-album.png',
          preview_url: null
        },
        {
          track_id: 'rec3',
          track_name: 'ä¸‘å…«ï¿?,
          artist_name: 'è–›ä¹‹ï¿?,
          title: 'ä¸‘å…«ï¿?,
          artist: 'è–›ä¹‹ï¿?,
          explanation: 'æ¥è‡ªæ‚¨å–œæ¬¢çš„è‰ºæœ¯å®¶è–›ä¹‹è°¦',
          album_image: '/static/img/default-album.png',
          preview_url: null
        }
      ],
      
      // èŠå¤©ç›¸å…³
      chatMessage: '',
      chatHistory: [],
      chatMessages: [],
      chatInput: '',
      isTyping: false,
      
      // è¯„ä¼°æ•°æ®
      satisfactionLevel: 0,
      feedbackText: '',
      evaluationComment: '',
      
      // ç³»ç»Ÿæ¶ˆæ¯
      notification: {
        message: '',
        type: 'info',
        isVisible: false
      },
      
      // é€šçŸ¥åˆ—è¡¨
      notifications: [],
      
      // éŸ³é¢‘æ’­æ”¾
      currentPreviewUrl: null,
      audioPlayer: null,
      
      // æƒ…ç»ªåˆ†æç›¸å…³
      emotionKeywords: [
        'éš¾è¿‡', 'ä¼¤å¿ƒ', 'æ‚²ä¼¤', 'å‹åŠ›', 'ç„¦è™‘', 'å¼€ï¿?, 'é«˜å…´', 'å…´å¥‹', 
        'ç”Ÿæ°”', 'æ„¤ï¿½?, 'æ— èŠ', 'ç–²æƒ«', 'å­¤ç‹¬', 'æ€å¿µ', 'å¤±è½', 
        'æƒ³å“­', 'ä¸å¼€ï¿?, 'æŠ‘éƒ', 'çƒ¦èº', 'å¿ƒæƒ…'
      ],
      lastEmotionAnalysis: null,
      isEmotionAnalysing: false,
      
      translations: {
        zh: {
          appTitle: 'æ·±åº¦æ¨èéŸ³ä¹',
          recommendations: 'æ¨è',
          chat: 'èŠå¤©',
          evaluation: 'è¯„ä»·',
          developer: 'å¼€å‘è€…æ¨¡ï¿?,
          logout: 'é€€å‡ºç™»ï¿?
        },
        en: {
          appTitle: 'Deep Recommend Music',
          recommendations: 'Recommendations',
          chat: 'Chat',
          evaluation: 'Evaluation',
          developer: 'Developer Mode',
          logout: 'Log Out'
        }
      },
      
      // åº•éƒ¨æè¿°æ›´æ–°ä»¥æåŠæ··åˆæ¨èç®—ï¿?
      footerDescription: {
        zh: 'æœ¬ç³»ç»Ÿé‡‡ç”¨æ··åˆæ¨èç®—ï¿?(SVD++, NCF, MLP å’ŒååŒè¿‡ï¿?ï¼Œç»“åˆå†…å®¹åˆ†æå’Œç”¨æˆ·è¡Œä¸ºï¼Œæä¾›ä¸ªæ€§åŒ–éŸ³ä¹æ¨èï¿?,
        en: 'This system uses a hybrid recommendation algorithm (SVD++, NCF, MLP, and Collaborative Filtering), combining content analysis and user behavior to provide personalized music recommendations.'
      },
      
      // ç”¨æˆ·åå¥½
      preferences: [],
      
      // é»˜è®¤æ¨èæ­Œæ›²
      defaultRecommendations: [
        {
          track_id: 'default_1',
          track_name: 'åƒé‡Œä¹‹å¤–',
          artist_name: 'å‘¨æ°ï¿?,
          title: 'åƒé‡Œä¹‹å¤–',
          artist: 'å‘¨æ°ï¿?,
          explanation: 'çƒ­é—¨åè¯­æ­Œæ›²æ¨è'
        },
        {
          track_id: 'default_2',
          track_name: 'èµ·é£ï¿?,
          artist_name: 'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸',
          title: 'èµ·é£ï¿?,
          artist: 'ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸',
          explanation: 'è¿‘æœŸæµè¡Œæ­Œæ›²æ¨è'
        }
      ]
    },
    
    // è®¡ç®—å±ï¿½?
    computed: {
      // å·²è¯„åˆ†çš„æ­Œæ›²æ•°é‡
      ratedSongsCount() {
        return Object.keys(this.userRatings).length;
      },
      
      // ç”¨æˆ·æ˜¯å¦å¯ä»¥è·å–æ¨è
      canGetRecommendations() {
        return this.ratedSongsCount >= 5 && this.user.isLoggedIn;
      },
      
      // ç”¨æˆ·æ˜¯å¦å·²ç»è¯„åˆ†è¶³å¤Ÿçš„æ­Œï¿?
      hasRatedEnoughSongs() {
        return this.ratedSongsCount >= 5;
      },
      
      // æ˜¾ç¤ºè¯­è¨€
      t() {
        return (key) => {
          const translations = this.currentLanguage === 'zh' ? this.translationsZh : this.translationsEn;
          return translations[key] || key;
        };
      },
      
      // è¯„ä¼°æ˜¯å¦å®Œæˆ
      isEvaluationComplete() {
        return this.evaluationResponses.filter(r => r !== '').length === this.evaluationQuestions.length;
      },
      
      // ç™»å½•çŠ¶ï¿½?(å…¼å®¹æ¨¡æ¿ä¸­çš„å˜é‡ï¿?
      isLoggedIn() {
        return this.user.isLoggedIn;
      }
    },
    
    // ç›‘å¬å±æ€§å˜ï¿?
    watch: {
      currentLanguage(newVal) {
        localStorage.setItem('preferredLanguage', newVal);
      },
      'user.isLoggedIn'(newValue) {
        if (newValue) {
          // ä¿å­˜ç”¨æˆ·IDåˆ°æœ¬åœ°å­˜ï¿?
          localStorage.setItem('musicRecommendUserId', this.user.id);
        }
      }
    },
    
    // åˆ›å»ºæ—¶æ‰§ï¿?
    created() {
      // åˆå§‹åŒ–æƒ…ç»ªå…³é”®è¯åˆ—è¡¨
      this.emotionKeywords = [
          'éš¾è¿‡', 'ä¼¤å¿ƒ', 'æ‚²ä¼¤', 'å‹åŠ›', 'ç„¦è™‘', 'å¼€ï¿?, 'é«˜å…´', 'å…´å¥‹', 
          'ç”Ÿæ°”', 'æ„¤ï¿½?, 'æ— èŠ', 'ç–²æƒ«', 'å­¤ç‹¬', 'æ€å¿µ', 'å¤±è½', 
          'æƒ³å“­', 'ä¸å¼€ï¿?, 'æŠ‘éƒ', 'çƒ¦èº', 'å¿ƒæƒ…'
      ];
      
      // æ£€æŸ¥ç”¨æˆ·ä¼šï¿?
      this.checkUserSession();
      
      // è®¾ç½®é»˜è®¤è¯­è¨€
      this.currentLanguage = localStorage.getItem('language') || 'zh';
      
      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è¯­è¨€åå¥½
      const savedLanguage = localStorage.getItem('preferredLanguage');
      if (savedLanguage) {
        this.currentLanguage = savedLanguage;
      }
      
      // åˆå§‹åŒ–åŠ è½½çŠ¶ï¿?
      this.isLoading = false;
      this.isLoadingRecommendations = false;
      
      // è®¾ç½®translationså¯¹è±¡
      if (!this.translations || !this.translations.zh || !this.translations.zh.welcome) {
        // ç¡®ä¿translationså¯¹è±¡å®Œæ•´
        this.translations = {
          zh: {
            appTitle: 'æ·±åº¦æ¨èéŸ³ä¹',
            recommendations: 'æ¨è',
            chat: 'èŠå¤©',
            evaluation: 'è¯„ä»·',
            developer: 'å¼€å‘è€…æ¨¡ï¿?,
            logout: 'é€€å‡ºç™»ï¿?,
            tabs: {
              welcome: 'æ¬¢è¿',
              rate: 'è¯„åˆ†',
              recommend: 'æ¨è',
              chat: 'èŠå¤©',
              evaluate: 'è¯„ä¼°',
              admin: 'ç”¨æˆ·ç®¡ç†'
            },
            welcome: {
              title: 'æ¬¢è¿ä½¿ç”¨éŸ³ä¹æ¨èç³»ç»Ÿ',
              subtitle: 'é€‰æ‹©ä¸‹é¢çš„é€‰é¡¹å¼€å§‹æ‚¨çš„éŸ³ä¹ä¹‹ï¿?,
              talkToAI: 'ä¸AIéŸ³ä¹åŠ©æ‰‹èŠå¤©',
              talkToAIDesc: 'å‘AIåŠ©æ‰‹è¯¢é—®éŸ³ä¹æ¨èã€è‰ºæœ¯å®¶ä¿¡æ¯æˆ–è¡¨è¾¾æ‚¨çš„æƒ…ç»ªï¼Œè·å–ä¸ªæ€§åŒ–éŸ³ä¹å»ºè®®',
              fillQuestionnaire: 'å¡«å†™éŸ³ä¹é—®å·',
              fillQuestionnaireDesc: 'é€šè¿‡å¯¹æ­Œæ›²è¯„åˆ†ï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„éŸ³ä¹åå¥½ï¼Œè·å–æ›´ç²¾å‡†çš„æ¨ï¿?
            }
          },
          en: {
            appTitle: 'Deep Recommend Music',
            recommendations: 'Recommendations',
            chat: 'Chat',
            evaluation: 'Evaluation',
            developer: 'Developer Mode',
            logout: 'Log Out',
            tabs: {
              welcome: 'Welcome',
              rate: 'Rate',
              recommend: 'Recommend',
              chat: 'Chat',
              evaluate: 'Evaluate',
              admin: 'User Admin'
            },
            welcome: {
              title: 'Welcome to Music Recommendation System',
              subtitle: 'Choose an option below to start your music journey',
              talkToAI: 'Chat with AI Music Assistant',
              talkToAIDesc: 'Ask the AI assistant for music recommendations, artist information, or express your emotions for personalized music suggestions',
              fillQuestionnaire: 'Fill Music Questionnaire',
              fillQuestionnaireDesc: 'Rate songs to help us understand your music preferences and get more accurate recommendations'
            }
          }
        };
      }
      
      // è®¾ç½®é»˜è®¤ç¤ºä¾‹æ­Œæ›²ï¼Œé˜²æ­¢æ¸²æŸ“é”™ï¿?
      this.sampleSongs = [
        { 
          track_id: '1', 
          track_name: 'æ™´å¤©', 
          artist_name: 'å‘¨æ°ï¿?, 
          album_name: 'å¶æƒ ï¿?,
          title: 'æ™´å¤©',
          artist: 'å‘¨æ°ï¿?,
          rating: 5,  // é»˜è®¤è¯„åˆ†ï¿?
          album_image: '/static/img/default-album.png'
        },
        { 
          track_id: '2', 
          track_name: 'Shape of You', 
          artist_name: 'Ed Sheeran', 
          album_name: 'Divide',
          title: 'Shape of You',
          artist: 'Ed Sheeran',
          rating: 4,  // é»˜è®¤è¯„åˆ†ï¿?
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: '3',
          track_name: 'æ¼”å‘˜',
          artist_name: 'è–›ä¹‹ï¿?,
          album_name: 'ç»…å£«',
          title: 'æ¼”å‘˜',
          artist: 'è–›ä¹‹ï¿?,
          rating: 5,
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: '4',
          track_name: 'Uptown Funk',
          artist_name: 'Mark Ronson ft. Bruno Mars',
          album_name: 'Uptown Special',
          title: 'Uptown Funk',
          artist: 'Mark Ronson ft. Bruno Mars',
          rating: 4,
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: '5',
          track_name: 'æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ï¿?,
          artist_name: 'åˆ˜æ˜ï¿?,
          album_name: 'æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ï¿?,
          title: 'æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ï¿?,
          artist: 'åˆ˜æ˜ï¿?,
          rating: 5,
          album_image: '/static/img/default-album.png'
        }
      ];
      
      // è®¾ç½®é»˜è®¤æ¨èæ•°æ®ï¼Œé˜²æ­¢æ¸²æŸ“é”™ï¿?
      this.recommendations = [
        {
          track_id: 'rec1',
          track_name: 'å‘Šç™½æ°”çƒ',
          artist_name: 'å‘¨æ°ï¿?,
          explanation: 'æ ¹æ®æ‚¨å–œæ¬¢çš„å‘¨æ°ä¼¦çš„ä½œå“æ¨è',
          title: 'å‘Šç™½æ°”çƒ',
          artist: 'å‘¨æ°ï¿?,
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: 'rec2',
          track_name: 'Perfect',
          artist_name: 'Ed Sheeran',
          explanation: 'ä¸æ‚¨å–œæ¬¢çš„Shape of Youé£æ ¼ç›¸ä¼¼',
          title: 'Perfect',
          artist: 'Ed Sheeran',
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: 'rec3',
          track_name: 'å…‰å¹´ä¹‹å¤–',
          artist_name: 'é‚“ç´«ï¿?,
          explanation: 'åŸºäºæ‚¨çš„æµè¡ŒéŸ³ä¹åå¥½æ¨è',
          title: 'å…‰å¹´ä¹‹å¤–',
          artist: 'é‚“ç´«ï¿?,
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: 'rec4',
          track_name: 'Thinking Out Loud',
          artist_name: 'Ed Sheeran',
          explanation: 'ä¸æ‚¨å–œæ¬¢çš„Shape of Youçš„è‰ºæœ¯å®¶ç›¸åŒ',
          title: 'Thinking Out Loud',
          artist: 'Ed Sheeran',
          album_image: '/static/img/default-album.png'
        },
        {
          track_id: 'rec5',
          track_name: 'å®‰é™',
          artist_name: 'å‘¨æ°ï¿?,
          explanation: 'æ ¹æ®æ‚¨å–œæ¬¢çš„å‘¨æ°ä¼¦çš„ä½œå“æ¨è',
          title: 'å®‰é™',
          artist: 'å‘¨æ°ï¿?,
          album_image: '/static/img/default-album.png'
        }
      ];
      
      // åˆå§‹åŒ–å¿…è¦çš„æ•°æ®ï¼Œé¿å…undefinedé”™è¯¯
      this.chatMessages = [];
      if (!Array.isArray(this.chatMessages)) {
        this.chatMessages = [];
      }
      
      // ç¡®ä¿å†…å®¹å¯¹è±¡å­˜åœ¨
      if (!this.content) {
        this.content = {
          welcome: {
            title: 'æ¬¢è¿ä½¿ç”¨éŸ³ä¹æ¨èç³»ç»Ÿ',
            subtitle: 'é€‰æ‹©ä¸‹é¢çš„é€‰é¡¹å¼€å§‹æ‚¨çš„éŸ³ä¹ä¹‹ï¿?,
            talkToAI: 'ä¸AIéŸ³ä¹åŠ©æ‰‹èŠå¤©',
            talkToAIDesc: 'å‘AIåŠ©æ‰‹è¯¢é—®éŸ³ä¹æ¨èã€è‰ºæœ¯å®¶ä¿¡æ¯æˆ–è¡¨è¾¾æ‚¨çš„æƒ…ç»ªï¼Œè·å–ä¸ªæ€§åŒ–éŸ³ä¹å»ºè®®',
            fillQuestionnaire: 'å¡«å†™éŸ³ä¹é—®å·',
            fillQuestionnaireDesc: 'é€šè¿‡å¯¹æ­Œæ›²è¯„åˆ†ï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„éŸ³ä¹åå¥½ï¼Œè·å–æ›´ç²¾å‡†çš„æ¨ï¿?
          },
          rate: {
            title: 'å¯¹æ­Œæ›²è¯„ï¿?,
            subtitle: 'è¯·å¯¹ä»¥ä¸‹æ­Œæ›²è¿›è¡Œè¯„åˆ†ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£æ‚¨çš„éŸ³ä¹å“å‘³',
            notRated: 'æœªè¯„ï¿?,
            continueButton: 'è·å–æ¨è',
            needMoreRatings: 'è¯·è‡³å°‘å¯¹5é¦–æ­Œæ›²è¯„ï¿?
          },
          recommend: {
            title: 'ä¸ªæ€§åŒ–æ¨è',
            subtitle: 'æ ¹æ®æ‚¨çš„è¯„åˆ†ï¼Œæˆ‘ä»¬æ¨èä»¥ä¸‹æ­Œï¿?,
            loading: 'æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆæ¨è...',
            noRecommendations: 'æš‚æ— æ¨èï¼Œè¯·å…ˆè¯„åˆ†æ›´å¤šæ­Œï¿?,
            rateMore: 'è¿”å›è¯„åˆ†æ›´å¤šæ­Œæ›²'
          },
          chat: {
            title: 'AIéŸ³ä¹åŠ©æ‰‹',
            subtitle: 'ä¸AIåŠ©æ‰‹äº¤æµï¼Œè·å–éŸ³ä¹æ¨èå’Œä¿¡æ¯',
            welcome: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIéŸ³ä¹åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ æ‰¾æ­Œæ›²ã€äº†è§£è‰ºæœ¯å®¶ã€è·å–æ¨èï¼Œæˆ–è€…å›ç­”éŸ³ä¹ç›¸å…³é—®é¢˜ã€‚è¯·éšæ—¶å‘æˆ‘æé—®ï¿?,
            inputPlaceholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¦ï¿?..'
          },
          evaluate: {
            title: 'ç³»ç»Ÿè¯„ä¼°',
            subtitle: 'è¯·å¯¹æ¨èç³»ç»Ÿè¿›è¡Œè¯„ä»·ï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹ï¿?,
            submit: 'æäº¤è¯„ä¼°',
            thanks: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¿?
          },
          header: {
            title: 'æ¬¢è¿ï¿?,
            subtitle: 'æ¢ç´¢æ‚¨çš„ä¸“å±éŸ³ä¹ä¸–ç•Œ',
            logout: 'é€€ï¿?
          },
          tabs: {
            welcome: 'æ¬¢è¿',
            rate: 'è¯„åˆ†',
            recommend: 'æ¨è',
            chat: 'èŠå¤©',
            evaluate: 'è¯„ä¼°'
          },
          footer: {
            title: 'éŸ³ä¹æ¨èç³»ç»Ÿ',
            description: 'ä¸€ä¸ªåŸºäºAIçš„ä¸ªæ€§åŒ–éŸ³ä¹æ¨èç³»ç»Ÿ'
          },
          errors: {
            emptyUsername: 'è¯·è¾“å…¥ç”¨æˆ·å',
            loginFailed: 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ï¿?
          },
          success: {
            login: 'ç™»å½•æˆåŠŸï¿?
          }
        };
      }
      
      // åˆå§‹åŒ–æƒ…ç»ªå…³é”®è¯æ•°ç»„
      if (!this.emotionKeywords || !Array.isArray(this.emotionKeywords)) {
        this.emotionKeywords = [
          'éš¾è¿‡', 'ä¼¤å¿ƒ', 'æ‚²ä¼¤', 'å‹åŠ›', 'ç„¦è™‘', 'å¼€ï¿?, 'é«˜å…´', 'å…´å¥‹', 
          'ç”Ÿæ°”', 'æ„¤ï¿½?, 'æ— èŠ', 'ç–²æƒ«', 'å­¤ç‹¬', 'æ€å¿µ', 'å¤±è½', 
          'æƒ³å“­', 'ä¸å¼€ï¿?, 'æŠ‘éƒ', 'çƒ¦èº', 'å¿ƒæƒ…'
        ];
      }
      
      // ç¡®ä¿å…¶ä»–å˜é‡æœ‰é»˜è®¤ï¿½?
      this.chatInput = '';
      this.notifications = [];
      this.evaluationResponses = [];
      this.currentPreviewUrl = null;
      
      // é¢„è®¾ç”¨æˆ·è¯„åˆ†æ•°æ®
      this.userRatings = {
        '1': 5, // æ™´å¤©è¯„åˆ†ï¿?
        '2': 4, // Shape of Youè¯„åˆ†ï¿?
        '3': 5, // æ¼”å‘˜è¯„åˆ†ï¿?
        '4': 4, // Uptown Funkè¯„åˆ†ï¿?
        '5': 5  // æ¼‚æ´‹è¿‡æµ·æ¥çœ‹ä½ è¯„åˆ†ä¸º5
      };
      
      // æ·»åŠ AIæ¬¢è¿æ¶ˆæ¯
      this.chatMessages.push({
        content: `æ¬¢è¿ï¿?{this.user.username}ï¼æˆ‘æ˜¯æ‚¨çš„AIéŸ³ä¹åŠ©æ‰‹ã€‚è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆéŸ³ä¹ä¿¡æ¯æˆ–è·å–ä»€ä¹ˆæ¨èï¼Ÿ`,
        isUser: false
      });
      
      // æ˜¾ç¤ºæ¬¢è¿é€šçŸ¥
      this.showNotification('æ¬¢è¿ä½¿ç”¨éŸ³ä¹æ¨èç³»ç»Ÿï¼æˆ‘ä»¬å·²ä¸ºæ‚¨å‡†å¤‡äº†ä¸€äº›æ¨èï¿½?, 'success');
      
      // è‡ªåŠ¨åŠ è½½ç¤ºä¾‹æ­Œæ›²ï¼ˆä½†ä¸è°ƒç”¨APIï¿?
      console.log('å·²åŠ è½½ç¤ºä¾‹æ­Œï¿?', this.sampleSongs.length);
      console.log('å·²è®¾ç½®ç”¨æˆ·è¯„ï¿?', Object.keys(this.userRatings).length);
      
      // å®šæ—¶åŠ¨ç”»æ•ˆæœ
      setTimeout(() => {
        const cards = document.querySelectorAll('.recommendation-item');
        if (cards && cards.length > 0) {
          cards.forEach((card, index) => {
            setTimeout(() => {
              card.classList.add('animate__animated', 'animate__fadeInUp');
            }, index * 100);
          });
        }
      }, 500);
    },
    
    // æ–¹æ³•å®šä¹‰
    methods: {
      // è·å–å¯¹åº”è¯­è¨€çš„ç¿»ï¿?
      getTranslation(key) {
        const translations = this.currentLanguage === 'zh' ? 
          (this.translations.zh || this.translationsZh) : 
          (this.translations.en || this.translationsEn);
        return translations[key] || key;
      },
      
      // åˆ‡æ¢è¯­è¨€
      switchLanguage(lang) {
        if (lang) {
          this.currentLanguage = lang;
        } else {
          // å¦‚æœæ²¡æœ‰æä¾›å‚æ•°ï¼Œåˆ™åˆ‡æ¢è¯­è¨€
          this.currentLanguage = this.currentLanguage === 'zh' ? 'en' : 'zh';
        }
        document.documentElement.lang = this.currentLanguage;
      },
      
      // åˆ‡æ¢æ ‡ç­¾ï¿?
      switchTab(tab) {
        if (tab === 'welcome') {
          console.log("åˆ‡æ¢åˆ°æ¬¢è¿é¡µï¿?);
        }
        this.currentTab = tab;
        
        // å¦‚æœåˆ‡æ¢åˆ°æ¨èæ ‡ç­¾é¡µï¼Œè·å–æ¨ï¿?
        if (tab === 'recommend' && this.canGetRecommendations) {
          this.getRecommendations();
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾é¡µï¼ŒåŠ è½½èŠå¤©å†ï¿?
        if (tab === 'chat' && this.user.isLoggedIn) {
          this.getChatHistory();
        }
      },
      
      // æ£€æŸ¥ç”¨æˆ·ä¼šï¿?
      checkUserSession() {
        const storedUser = localStorage.getItem('user');
        if (storedUser) {
          this.user = JSON.parse(storedUser);
        }
      },
      
      // åŠ è½½åˆå§‹æ•°æ®
      loadInitialData() {
        // åŠ è½½ç¤ºä¾‹æ­Œæ›²
        this.loadSampleSongs();
        
        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè·å–ç”¨æˆ·è¯„åˆ†è®°å½•
        if (this.user.isLoggedIn) {
          this.getUserRatings();
        }
      },
      
      // åŠ è½½ç¤ºä¾‹æ­Œæ›²
      loadSampleSongs() {
        // ä½¿ç”¨é¢„è®¾çš„ç¤ºä¾‹æ­Œæ›²æ•°æ®ï¼Œä¸å‘é€APIè¯·æ±‚
        console.log('ä½¿ç”¨é¢„è®¾çš„ç¤ºä¾‹æ­Œæ›²æ•°ï¿?);
        
        // è®¾ç½®åŠ è½½çŠ¶ï¿½?
        this.isLoading = true;
        
        // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        setTimeout(() => {
          this.isLoading = false;
          console.log('å·²åŠ è½½ç¤ºä¾‹æ­Œï¿?', this.sampleSongs.length);
          
          // å¦‚æœæœ‰ç”¨æˆ·è¯„åˆ†æ•°æ®ï¼Œåº”ç”¨åˆ°æ­Œæ›²ä¸Š
          if (Object.keys(this.userRatings).length > 0) {
            this.sampleSongs.forEach(song => {
              if (this.userRatings[song.track_id]) {
                song.rating = this.userRatings[song.track_id];
              }
            });
          }
        }, 500);
      },
      
      // è·å–ç”¨æˆ·è¯„åˆ†è®°å½•
      getUserRatings() {
        if (!this.user.isLoggedIn) return;
        
        this.isLoading = true;
        
        // ä½¿ç”¨ç”¨æˆ·åä½œä¸ºID
        const userId = this.user.id || this.user.username;
        
        axios.get(`/api/user_ratings/${userId}`)
          .then(response => {
            this.userRatings = response.data || {};
            console.log('å·²åŠ è½½ç”¨æˆ·è¯„ï¿?', Object.keys(this.userRatings).length);
            
            // æ›´æ–°ç¤ºä¾‹æ­Œæ›²çš„è¯„ï¿?
            if (this.sampleSongs.length > 0) {
              this.sampleSongs.forEach(song => {
                if (this.userRatings[song.track_id]) {
                  this.$set(song, 'rating', this.userRatings[song.track_id]);
                }
              });
            }
          })
          .catch(error => {
            console.error('åŠ è½½ç”¨æˆ·è¯„åˆ†å¤±è´¥:', error);
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // è¯„åˆ†æ­Œæ›²
      rateSong(trackId, rating) {
        if (!this.user.isLoggedIn) {
          this.showNotification('è¯·å…ˆç™»å½•åå†è¯„åˆ†', 'warning');
          return;
        }
        
        this.isLoading = true;
        
        // åŠ¨ç”»æ•ˆæœæ ‡è®°è¯¥æ­Œæ›²å·²è¯„åˆ†
        const songElement = document.querySelector(`[data-track-id="${trackId}"]`);
        if (songElement) {
          songElement.classList.add('animate__animated', 'animate__pulse');
          setTimeout(() => {
            songElement.classList.remove('animate__animated', 'animate__pulse');
          }, 1000);
        }
        
        axios.post('/api/rate_song', {
          user_id: this.user.id,
          track_id: trackId,
          rating: rating
        })
          .then(response => {
            // æ›´æ–°æœ¬åœ°è¯„åˆ†è®°å½•
            this.$set(this.userRatings, trackId, rating);
            console.log('æ­Œæ›²è¯„åˆ†æˆåŠŸ:', trackId, rating);
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è·å–æ¨ï¿?
            if (this.canGetRecommendations) {
              this.showNotification('æ‚¨å·²è¯„åˆ†è¶³å¤Ÿçš„æ­Œæ›²ï¼Œå¯ä»¥è·å–ä¸ªæ€§åŒ–æ¨èï¿?, 'success');
            }
          })
          .catch(error => {
            console.error('æ­Œæ›²è¯„åˆ†å¤±è´¥:', error);
            this.showNotification('è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // è·å–æ¨èæ­Œæ›²
      getRecommendations() {
        // æˆ‘ä»¬å·²ç»æœ‰é¢„è®¾çš„æ¨èæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨å®ƒï¿?
        console.log('ä½¿ç”¨é¢„è®¾çš„æ¨èæ•°ï¿?);
        
        // è®¾ç½®åŠ è½½çŠ¶ï¿½?
        this.isLoadingRecommendations = true;
        
        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
        setTimeout(() => {
          this.isLoadingRecommendations = false;
          
          // æ·»åŠ åŠ¨ç”»æ•ˆæœ
          setTimeout(() => {
            const cards = document.querySelectorAll('.recommendation-item');
            if (cards && cards.length > 0) {
              cards.forEach((card, index) => {
                setTimeout(() => {
                  card.classList.add('animate__animated', 'animate__fadeInUp');
                }, index * 100);
              });
            }
          }, 100);
          
          this.showNotification('å·²ä¸ºæ‚¨ç”Ÿæˆæ¨èæ­Œæ›²ï¼', 'success');
        }, 1000);
      },
      
      // å‘é€èŠå¤©æ¶ˆï¿?
      sendChatMessage() {
        if (!this.chatInput.trim()) {
            return;
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠï¿?
        this.addChatMessage(this.chatInput, true);
        
        // ä¿å­˜ç”¨æˆ·è¾“å…¥
        const userMessage = this.chatInput;
        this.chatInput = '';
        
        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çš„çŠ¶ï¿?
        this.isTyping = true;
        
        // åˆ†ææ¶ˆæ¯æ˜¯å¦åŒ…å«æƒ…ç»ªå†…å®¹
        if (this.containsEmotionKeywords(userMessage)) {
            this.analyzeEmotionAndRecommend(userMessage);
        } else {
            this.sendRegularChatMessage(userMessage);
        }
      },
      
      /**
       * å‘é€å¸¸è§„èŠå¤©æ¶ˆæ¯åˆ°API
       */
      sendRegularChatMessage(message) {
        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        axios.post('/api/chat', {
            user_id: this.user.id,
            message: message
        })
        .then(response => {
            this.isTyping = false;
            
            if (response.data && response.data.response) {
                // æ·»åŠ AIå›å¤åˆ°èŠï¿?
                this.addChatMessage(response.data.response);
                
                // ä¿å­˜èŠå¤©è®°å½•
                this.saveChatHistory();
            } else {
                this.addChatMessage("æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›åº”æ‚¨çš„é—®é¢˜ã€‚è¯·ç¨åå†è¯•ï¿?);
            }
        })
        .catch(error => {
            this.isTyping = false;
            console.error('èŠå¤©æ¶ˆæ¯å‘é€é”™ï¿?', error);
            this.addChatMessage("ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–å›å¤ã€‚è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åå†è¯•ï¿?);
        });
      },
      
      /**
       * åˆ†æç”¨æˆ·æƒ…ç»ªå¹¶æ¨èéŸ³ï¿?
       */
      analyzeEmotionAndRecommend(message) {
        if (!message || !this.user || !this.user.id) {
          console.error('analyzeEmotionAndRecommend: å‚æ•°ä¸å®Œï¿?);
          this.showNotification('æ— æ³•åˆ†ææƒ…ç»ªï¼Œè¯·ç¨åå†è¯•', 'error');
          this.isLoading = false;
          return;
        }
        
        this.isEmotionAnalysing = true;
        
        axios.post('/api/emotion/analyze', {
          user_id: this.user.id,
          message: message
        })
          .then(response => {
            // ä¿å­˜æƒ…ç»ªåˆ†æç»“æœ
            this.lastEmotionAnalysis = {
              emotion: response.data.emotion || 'neutral',
              intensity: response.data.intensity || 0.5,
              description: response.data.description || 'æ‚¨çš„æƒ…ç»ªçŠ¶ï¿½?,
              music_suggestion: response.data.music_suggestion || 'é€‚åˆæ‚¨å½“å‰æƒ…ç»ªçš„éŸ³ä¹'
            };
            
            // æ·»åŠ  AI å›å¤åˆ°èŠå¤©å†ï¿?
            this.chatMessages.push({
              content: response.data.response || 'æˆ‘äº†è§£äº†æ‚¨çš„æƒ…ç»ªï¼Œè®©æˆ‘ä¸ºæ‚¨æ¨èä¸€äº›é€‚åˆçš„éŸ³ä¹ï¿½?,
              isUser: false
            });
            
            // å¦‚æœç”¨æˆ·å½“å‰åœ¨èŠå¤©æ ‡ç­¾ï¼Œæç¤ºå¯ä»¥åœ¨æ¨èæ ‡ç­¾æŸ¥çœ‹ç›¸å…³éŸ³ï¿?
            if (this.currentTab === 'chat') {
              this.showNotification('AIåŠ©æ‰‹å·²åˆ†ææ‚¨çš„æƒ…ç»ªå¹¶æ¨èäº†é€‚åˆçš„éŸ³ï¿?, 'info');
            }
            
            // å°è¯•è·å–åŸºäºæƒ…ç»ªçš„éŸ³ä¹æ¨ï¿?
            if (response.data.emotion) {
              this.getEmotionBasedMusic(response.data.emotion);
            }
          })
          .catch(error => {
            console.error('æƒ…ç»ªåˆ†æè¯·æ±‚å‡ºé”™:', error);
            
            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            this.chatMessages.push({
              content: 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•åˆ†ææ‚¨çš„æƒ…ç»ªã€‚è¯·ç¨åå†è¯•æˆ–å°è¯•ä¸åŒçš„è¡¨è¾¾æ–¹å¼ï¿?,
              isUser: false
            });
            
            this.showNotification('æƒ…ç»ªåˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'danger');
          })
          .finally(() => {
            this.isLoading = false;
            this.isEmotionAnalysing = false;
            
            // æ»šåŠ¨åˆ°åº•ï¿?
            this.$nextTick(() => {
              const chatContainer = document.querySelector('.chat-messages');
              if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            });
          });
      },
      
      /**
       * è·å–åŸºäºæƒ…ç»ªçš„éŸ³ä¹æ¨ï¿?
       */
      getEmotionBasedMusic(emotion) {
        if (!this.user || !this.user.isLoggedIn || !emotion) {
          console.error('getEmotionBasedMusic: ç¼ºå°‘å¿…è¦å‚æ•°');
          return;
        }
        
        this.isLoading = true;
        
        // ç¡®ä¿å…ˆè®¾ç½®é»˜è®¤æ¨èï¼Œé˜²æ­¢undefinedé”™è¯¯
        this.recommendations = [
          {
            track_id: 'default1',
            track_name: 'æƒ…ç»ªæ¨èæ­Œæ›²1',
            artist_name: 'æƒ…ç»ªè‰ºæœ¯ï¿?',
            explanation: `åŸºäºæ‚¨çš„${emotion}æƒ…ç»ªæ¨è`,
            title: 'æƒ…ç»ªæ¨èæ­Œæ›²1',
            artist: 'æƒ…ç»ªè‰ºæœ¯ï¿?',
            album_image: '/static/img/default-album.png'
          },
          {
            track_id: 'default2',
            track_name: 'æƒ…ç»ªæ¨èæ­Œæ›²2',
            artist_name: 'æƒ…ç»ªè‰ºæœ¯ï¿?',
            explanation: `åŸºäºæ‚¨çš„${emotion}æƒ…ç»ªæ¨è`,
            title: 'æƒ…ç»ªæ¨èæ­Œæ›²2',
            artist: 'æƒ…ç»ªè‰ºæœ¯ï¿?',
            album_image: '/static/img/default-album.png'
          }
        ];
        
        axios.get(`/api/emotion/music?user_id=${this.user.id}&emotion=${emotion}`)
          .then(response => {
            // ç¡®ä¿è¿”å›æ•°æ®æ˜¯æ•°ï¿?
            if (response.data && Array.isArray(response.data) && response.data.length > 0) {
              // ç¡®ä¿æ¯ä¸ªæ¨èå¯¹è±¡éƒ½æœ‰titleå’Œartistå­—æ®µ
              const processedRecommendations = response.data.map(rec => {
                // ç¡®ä¿recæ˜¯ä¸€ä¸ªå¯¹ï¿?
                if (!rec || typeof rec !== 'object') {
                  return {
                    track_id: 'æœªçŸ¥ID',
                    track_name: 'æœªçŸ¥æ ‡é¢˜',
                    artist_name: 'æœªçŸ¥è‰ºæœ¯ï¿?,
                    title: 'æœªçŸ¥æ ‡é¢˜',
                    artist: 'æœªçŸ¥è‰ºæœ¯ï¿?,
                    explanation: `åŸºäºæ‚¨çš„${emotion}æƒ…ç»ªæ¨è`,
                    album_image: '/static/img/default-album.png'
                  };
                }
                
                return {
                  ...rec,
                  track_id: rec.track_id || rec.id || `æœªçŸ¥ID_${Math.random()}`,
                  track_name: rec.track_name || rec.title || 'æœªçŸ¥æ ‡é¢˜',
                  artist_name: rec.artist_name || rec.artist || 'æœªçŸ¥è‰ºæœ¯ï¿?,
                  title: rec.track_name || rec.title || 'æœªçŸ¥æ ‡é¢˜',
                  artist: rec.artist_name || rec.artist || 'æœªçŸ¥è‰ºæœ¯ï¿?,
                  explanation: rec.explanation || `åŸºäºæ‚¨çš„${emotion}æƒ…ç»ªæ¨è`,
                  album_image: rec.album_image || rec.image || '/static/img/default-album.png'
                };
              });
              
              // æ›´æ–°æ¨èåˆ—è¡¨
              this.recommendations = processedRecommendations;
            }
            
            // å¦‚æœç”¨æˆ·å½“å‰åœ¨èŠå¤©æ ‡ç­¾ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªæŒ‰é’®åˆ‡æ¢åˆ°æ¨èæ ‡ç­¾
            if (this.currentTab === 'chat') {
              // æ·»åŠ ä¸€ä¸ªæç¤ºï¼Œå¯ä»¥ç”¨æŒ‰é’®åˆ‡ï¿?
              this.showNotification('æƒ…ç»ªéŸ³ä¹å·²å‡†å¤‡å¥½ï¼Œå¯åœ¨æ¨èæ ‡ç­¾æŸ¥ï¿?, 'success');
            }
          })
          .catch(error => {
            console.error('è·å–æƒ…ç»ªéŸ³ä¹å¤±è´¥:', error);
            this.showNotification('è·å–æƒ…ç»ªéŸ³ä¹æ¨èå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨ï¿?, 'danger');
            // é»˜è®¤æ¨èå·²åœ¨æ–¹æ³•å¼€å§‹æ—¶è®¾ç½®
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // è·å–èŠå¤©å†å²
      getChatHistory() {
        if (!this.user.isLoggedIn) return;
        
        this.isLoading = true;
        
        axios.get(`/api/chat/history?user_id=${this.user.id}`)
          .then(response => {
            this.chatHistory = response.data.history || [];
            console.log('å·²åŠ è½½èŠå¤©å†ï¿?', this.chatHistory.length);
            
            // è½¬æ¢ä¸ºå…¼å®¹æ¨¡æ¿çš„æ ¼å¼
            this.chatMessages = this.chatHistory.flatMap(record => [
              { content: record.user_message, isUser: true },
              { content: record.ai_response, isUser: false }
            ]);
          })
          .catch(error => {
            console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      /**
       * ä½¿ç”¨é¢„è®¾æç¤ºæ¶ˆæ¯
       */
      usePrompt(prompt) {
        if (!prompt) return;
        
        this.chatInput = prompt;
        
        this.$nextTick(() => {
          // è®©è¾“å…¥æ¡†è·å–ç„¦ç‚¹
          const inputElement = document.querySelector('.chat-input-container input');
          if (inputElement) {
            inputElement.focus();
          }
          
          // ä¹Ÿå¯ä»¥ç›´æ¥å‘é€æ¶ˆï¿?
          // this.sendChatMessage();
        });
      },
      
      // æäº¤åé¦ˆ
      submitFeedback(songId, feedbackType) {
        if (!this.user.isLoggedIn) return;
        
        axios.post('/api/feedback', {
          user_id: this.user.id,
          track_id: songId,
          feedback_type: feedbackType
        })
          .then(response => {
            console.log('åé¦ˆæäº¤æˆåŠŸ:', songId, feedbackType);
            this.showNotification('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¿?, 'success');
            
            // ä»æ¨èåˆ—è¡¨ä¸­ç§»é™¤è¯¥æ­Œæ›²å¹¶æ·»åŠ æ·¡å‡ºåŠ¨ç”»
            if (feedbackType === 'dislike') {
              const index = this.recommendations.findIndex(song => song.track_id === songId);
              if (index !== -1) {
                const songElement = document.querySelectorAll('.card')[index];
                if (songElement) {
                  songElement.classList.add('animate__animated', 'animate__fadeOut');
                  
                  setTimeout(() => {
                    this.recommendations.splice(index, 1);
                  }, 500);
                }
              }
            }
          })
          .catch(error => {
            console.error('åé¦ˆæäº¤å¤±è´¥:', error);
            this.showNotification('åé¦ˆæäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
          });
      },
      
      // æäº¤æ»¡æ„åº¦è¯„ï¿?
      submitEvaluation() {
        if (!this.user.isLoggedIn || !this.isEvaluationComplete) return;
        
        this.isLoading = true;
        
        axios.post('/api/evaluation', {
          user_id: this.user.id,
          responses: this.evaluationResponses,
          comment: this.evaluationComment
        })
          .then(response => {
            console.log('æ»¡æ„åº¦è¯„ä¼°æäº¤æˆï¿?', this.evaluationResponses);
            this.showNotification('æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¿?, 'success');
            this.evaluationSubmitted = true;
            this.satisfactionLevel = 0;
            this.feedbackText = '';
          })
          .catch(error => {
            console.error('æ»¡æ„åº¦è¯„ä¼°æäº¤å¤±ï¿?', error);
            this.showNotification('è¯„ä»·æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification(message, type = 'info') {
        this.notification.message = message;
        this.notification.type = type;
        this.notification.isVisible = true;
        
        // æ·»åŠ åˆ°é€šçŸ¥åˆ—è¡¨
        const notificationType = type === 'danger' ? 'is-danger' : 
                                type === 'warning' ? 'is-warning' : 
                                type === 'success' ? 'is-success' : 'is-info';
        this.notifications.push({
          message: message,
          type: notificationType
        });
        
        // 3ç§’åè‡ªåŠ¨éšè—é€šçŸ¥
        setTimeout(() => {
          this.notification.isVisible = false;
        }, 3000);
        
        // 3ç§’åä»é€šçŸ¥åˆ—è¡¨ä¸­ç§»ï¿?
        setTimeout(() => {
          if (this.notifications.length > 0) {
            this.notifications.shift();
          }
        }, 3000);
      },
      
      // ç”¨æˆ·æ³¨å†Œ
      register() {
        if (!this.username.trim()) {
          this.loginErrorMessage = 'è¯·è¾“å…¥ç”¨æˆ·å';
          return;
        }
        
        if (!this.email.trim()) {
          this.loginErrorMessage = 'è¯·è¾“å…¥é‚®ï¿?;
          return;
        }
        
        if (!this.password.trim()) {
          this.loginErrorMessage = 'è¯·è¾“å…¥å¯†ï¿?;
          return;
        }
        
        this.isLoading = true;
        this.loginErrorMessage = '';
        
        // å‡†å¤‡æ³¨å†Œæ•°æ®
        const registerData = {
          username: this.username,
          password: this.password,
          email: this.email
        };
        
        // å‘é€æ³¨å†Œè¯·ï¿?
        axios.post('/api/user/register', registerData)
          .then(response => {
            console.log('æ³¨å†ŒæˆåŠŸ:', response.data);
            
            if (response.data && response.data.user_id) {
              // æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»ï¿?
              this.user = {
                id: response.data.user_id,
                username: response.data.username || this.username,
                email: this.email,
                isLoggedIn: true,
                isDeveloper: response.data.is_developer || false
              };
              
              // ä¿å­˜åˆ°æœ¬åœ°å­˜ï¿?
              localStorage.setItem('userId', this.user.id);
              localStorage.setItem('username', this.user.username);
              localStorage.setItem('email', this.user.email);
              localStorage.setItem('isLoggedIn', 'true');
              localStorage.setItem('isDeveloper', this.user.isDeveloper ? 'true' : 'false');
              
              // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
              this.showNotification('æ³¨å†Œå¹¶ç™»å½•æˆåŠŸï¼', 'success');
              
              // åŠ è½½åˆå§‹æ•°æ®
              this.loadSampleSongs();
              
              // æ·»åŠ AIæ¬¢è¿æ¶ˆæ¯
              this.chatMessages.push({
                content: `æ¬¢è¿ï¿?{this.username}ï¼æˆ‘æ˜¯æ‚¨çš„AIéŸ³ä¹åŠ©æ‰‹ã€‚è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆéŸ³ä¹ä¿¡æ¯æˆ–è·å–ä»€ä¹ˆæ¨èï¼Ÿ`,
                isUser: false
              });
            } else {
              // æ³¨å†ŒæˆåŠŸä½†æ²¡æœ‰è¿”å›ç”¨æˆ·IDï¼Œå°è¯•ç™»ï¿?
              this.login();
            }
          })
          .catch(error => {
            console.error('æ³¨å†Œå¤±è´¥:', error);
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            if (error.response && error.response.data && error.response.data.error) {
              this.loginErrorMessage = error.response.data.error;
            } else {
              this.loginErrorMessage = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
            }
            
            this.isLoading = false;
          });
      },
      
      /**
       * ç”¨æˆ·ç™»å½•
       */
      login: function() {
        console.log("å¼€å§‹ç™»å½•æµç¨‹ï¼Œå½“å‰ç”¨æˆ·åï¼š", this.username, "å½“å‰ç»‘å®šå­—æ®µ:", document.querySelector("input[v-model='username']") ? true : false);
        
        if (this.user && this.user.isLoggedIn) {
            console.log("ç”¨æˆ·å·²ç™»å½•ï¼Œè·³è¿‡ç™»å½•è¿‡ç¨‹");
            return;
        }
        
        if (!this.username) {
            // ä¿®å¤é”™è¯¯ï¼šç¡®ä¿å³ä½¿åœ¨è‹±æ–‡ç•Œé¢ä¸‹ä¹Ÿèƒ½è®¿é—®é”™è¯¯æ¶ˆï¿?
            let errorMessage = "è¯·è¾“å…¥ç”¨æˆ·å";
            
            // å®‰å…¨åœ°è®¿é—®errorså¯¹è±¡
            if (this.content && this.content[this.currentLanguage] && 
                this.content[this.currentLanguage].errors && 
                this.content[this.currentLanguage].errors.emptyUsername) {
                errorMessage = this.content[this.currentLanguage].errors.emptyUsername;
            }
            
            this.addNotification(errorMessage, 'is-danger');
            return;
        }
        
        // å¼€å§‹ç™»å½•æµï¿?
        this.isLoading = true;
        
        // å‡†å¤‡ç™»å½•æ•°æ®
        var loginData = {
            username: this.username,
            email: this.email || "",
            password: this.password || ""
        };
        
        console.log("ç™»å½•æ•°æ®:", loginData);
        
        // å¼€å‘è€…ç™»å½•é€»è¾‘ç®€ï¿?
        if (this.isDeveloperMode && !this.password) {
            loginData.password = "test123";
        }
        
        axios.post('/api/user/login', loginData)
            .then(response => {
                console.log("ç™»å½•æˆåŠŸ:", response.data);
                
                // ç¡®ä¿ç”¨æˆ·æ•°æ®åŒ…å«æ‰€æœ‰å¿…è¦å­—ï¿?
                const userData = {
                    username: response.data.username || this.username,
                    email: response.data.email || this.email || "",
                    isDeveloper: response.data.is_developer || false,
                    isLoggedIn: true,
                    id: response.data.id || response.data.user_id || Date.now()
                };
                
                // ä¿å­˜ç”¨æˆ·ä¼šè¯åˆ°æœ¬åœ°å­˜ï¿?
                localStorage.setItem('user', JSON.stringify(userData));
                localStorage.setItem('user_session', JSON.stringify(userData)); // åŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ªkey
                localStorage.setItem('userId', userData.id);
                localStorage.setItem('username', userData.username);
                localStorage.setItem('isLoggedIn', 'true');
                
                // æ›´æ–°åº”ç”¨çŠ¶ï¿½?
                this.user = userData;
                this.username = userData.username;
                this.isDeveloperMode = userData.isDeveloper;
                
                // é‡ç½®ç™»å½•è¡¨å•
                this.loginUsername = "";
                this.password = "";
                this.loginEmail = "";
                this.isRegistering = false;
                
                // åŠ è½½åˆå§‹æ•°æ®
                this.loadInitialData();
                
                // ä¿®æ”¹è¿™é‡Œï¼šç™»å½•æˆåŠŸåæ˜¾ç¤ºæ¬¢è¿é¡µé¢
                this.currentTab = 'welcome';
                
                // å®‰å…¨åœ°è®¿é—®æˆåŠŸæ¶ˆï¿?
                let successMessage = "ç™»å½•æˆåŠŸï¿?;
                if (this.content && this.content[this.currentLanguage] && 
                    this.content[this.currentLanguage].success && 
                    this.content[this.currentLanguage].success.login) {
                    successMessage = this.content[this.currentLanguage].success.login;
                }
                
                this.addNotification(successMessage, 'is-success');
                
                // å‘æ§åˆ¶å°æ‰“å°ç™»å½•æˆåŠŸä¿¡æ¯
                console.log("ç”¨æˆ·ç™»å½•æˆåŠŸ", this.user);
                console.log("å½“å‰Tab:", this.currentTab);
            })
            .catch(error => {
                console.error("ç™»å½•é”™è¯¯:", error.response ? error.response.data : error);
                
                // å®‰å…¨åœ°è®¿é—®é”™è¯¯æ¶ˆï¿?
                let errorMessage = "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ï¿?;
                if (this.content && this.content[this.currentLanguage] && 
                    this.content[this.currentLanguage].errors && 
                    this.content[this.currentLanguage].errors.loginFailed) {
                    errorMessage = this.content[this.currentLanguage].errors.loginFailed;
                }
                
                if (error.response && error.response.data && error.response.data.error) {
                    errorMessage = error.response.data.error;
                }
                
                this.addNotification(errorMessage, 'is-danger');
            })
            .finally(() => {
                this.isLoading = false;
            });
      },
      
      /**
       * é€‰æ‹©å¡«å†™è°ƒæŸ¥é—®å·
       */
      chooseSurvey: function() {
        // åˆå§‹åŒ–è°ƒæŸ¥é—®ï¿?
        this.surveyQuestions.find(q => q.id === 'music_genres').options = this.musicGenres;
        this.surveyCompleted = false;
        this.showWelcomeOptions = false;
        this.showPreferencesSurvey = true;
        this.currentTab = 'survey';
      },
      
      /**
       * é€‰æ‹©AIèŠå¤©
       */
      chooseAIChat: function() {
        this.showWelcomeOptions = false;
        this.currentTab = 'chat';
        this.loadChatHistory();
      },
      
      /**
       * å›ç­”è°ƒæŸ¥é—®é¢˜
       */
      answerQuestion: function(questionId, answer) {
        const question = this.surveyQuestions.find(q => q.id === questionId);
        if (!question) return;
        
        if (question.type === 'single') {
          // å•é€‰é¢˜ç›´æ¥è®¾ç½®ç­”æ¡ˆ
          question.answer = answer;
        } else if (question.type === 'multiple') {
          // å¤šé€‰é¢˜å¤„ç†é€‰ä¸­/å–æ¶ˆé€‰ä¸­
          const index = question.answer.indexOf(answer);
          if (index === -1) {
            // æ·»åŠ é€‰é¡¹
            question.answer.push(answer);
          } else {
            // ç§»é™¤é€‰é¡¹
            question.answer.splice(index, 1);
          }
        }
      },
      
      /**
       * æäº¤è°ƒæŸ¥é—®å·
       */
      submitSurvey: function() {
        // æ”¶é›†ç”¨æˆ·åå¥½
        this.preferences = [];
        
        // å°†é—®å·ç­”æ¡ˆè½¬æ¢ä¸ºåå¥½
        this.surveyQuestions.forEach(question => {
          if (question.id === 'music_genres' && question.answer.length > 0) {
            this.selectedGenres = [...question.answer];
          }
          
          if (question.answer && 
             (question.type === 'single' && question.answer !== '') || 
             (question.type === 'multiple' && question.answer.length > 0)) {
            this.preferences.push({
              preference_id: question.id,
              preference_type: question.type,
              preference_value: JSON.stringify(question.answer)
            });
          }
        });
        
        // ä¿å­˜ç”¨æˆ·åå¥½åˆ°æœ¬åœ°å­˜ï¿?
        localStorage.setItem('user_preferences', JSON.stringify(this.preferences));
        
        // æ ‡è®°è°ƒæŸ¥å®Œæˆ
        this.surveyCompleted = true;
        this.showPreferencesSurvey = false;
        
        // åŠ è½½ä¸ªæ€§åŒ–æ¨è
        this.getPersonalizedRecommendations();
        
        // æ˜¾ç¤ºé€šçŸ¥
        this.showNotification(
          this.currentLanguage === 'zh' ? 'æ„Ÿè°¢æ‚¨å®Œæˆè°ƒæŸ¥ï¼' : 'Thank you for completing the survey!',
          'success'
        );
      },
      
      /**
       * è·³è¿‡è°ƒæŸ¥
       */
      skipSurvey: function() {
        this.surveyCompleted = true;
        this.showPreferencesSurvey = false;
        
        // åŠ è½½é»˜è®¤æ¨è
        this.recommendations = [...this.defaultRecommendations];
        this.currentTab = 'recommendations';
        
        // é€šçŸ¥ç”¨æˆ·
        this.showNotification(
          this.currentLanguage === 'zh' ? 'å·²è·³è¿‡è°ƒï¿? : 'Survey skipped',
          'info'
        );
      },
      
      /**
       * è·å–ä¸ªæ€§åŒ–æ¨è
       */
      getPersonalizedRecommendations: function() {
        // è®¾ç½®åŠ è½½çŠ¶ï¿½?
        this.isLoading = true;
        this.recommendations = [...this.defaultRecommendations]; // è®¾ç½®é»˜è®¤ï¿?
        
        // å‡†å¤‡è¯·æ±‚å‚æ•°
        const params = {
          user_id: this.user.id,
          genres: this.selectedGenres.join(',')
        };
        
        // åˆ‡æ¢åˆ°æ¨èé€‰é¡¹ï¿?
        this.currentTab = 'recommendations';
        
        // å‘APIå‘é€è¯·ï¿?
        axios.get('/api/recommendations/personalized', { params: params })
          .then(response => {
            this.isLoading = false;
            
            if (response.data && response.data.recommendations && response.data.recommendations.length > 0) {
              // ç¡®ä¿æ¯ä¸ªæ¨èé¡¹éƒ½æœ‰titleå’Œartistå­—æ®µ
              this.recommendations = response.data.recommendations.map(rec => {
                return {
                  track_id: rec.track_id || '',
                  track_name: rec.track_name || '',
                  artist_name: rec.artist_name || '',
                  title: rec.title || rec.track_name || '',
                  artist: rec.artist || rec.artist_name || '',
                  explanation: rec.explanation || 'æ ¹æ®æ‚¨çš„åå¥½æ¨è'
                };
              });
              
              // è®°å½•åŠ è½½çš„æ¨èæ•°ï¿?
              console.log('å·²åŠ ï¿? + this.recommendations.length + 'æ¡ä¸ªæ€§åŒ–æ¨è');
              
              // æ·»åŠ åŠ¨ç”»æ•ˆæœ
              setTimeout(() => {
                const cards = document.querySelectorAll('.recommendation-card');
                cards.forEach((card, index) => {
                  setTimeout(() => {
                    card.classList.add('show');
                  }, index * 100);
                });
              }, 100);
            } else {
              // æ¨èåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨ï¿?
              console.log('æœªèƒ½è·å–ä¸ªæ€§åŒ–æ¨èï¼Œä½¿ç”¨é»˜è®¤æ¨ï¿?);
            }
          })
          .catch(error => {
            this.isLoading = false;
            console.error('è·å–ä¸ªæ€§åŒ–æ¨èå‡ºé”™:', error);
            
            // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
            this.showNotification(
              this.currentLanguage === 'zh' ? 'è·å–æ¨èå¤±è´¥ï¼Œè¯·ç¨åå†è¯•' : 'Failed to get recommendations, please try again later',
              'error'
            );
          });
      },
      
      // ç™»å‡ºç”¨æˆ·
      logoutUser: function() {
        // æ¸…é™¤ç”¨æˆ·çŠ¶ï¿½?
        this.user.id = null;
        this.user.username = '';
        this.user.email = '';
        this.user.isLoggedIn = false;
        this.user.isDeveloper = false;
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('user');
        localStorage.removeItem('user_preferences');
        
        // é‡ç½®ç•Œé¢çŠ¶ï¿½?
        this.showLoginForm = true;
        this.showWelcomeOptions = false;
        this.showPreferencesSurvey = false;
        this.currentTab = 'welcome';
        this.selectedGenres = [];
        
        // æ¸…ç©ºé—®å·ç­”æ¡ˆ
        this.surveyQuestions.forEach(question => {
          if (question.type === 'single') {
            question.answer = '';
          } else {
            question.answer = [];
          }
        });
        
        // æ˜¾ç¤ºé€šçŸ¥
        this.showNotification(
          this.currentLanguage === 'zh' ? 'å·²æˆåŠŸé€€å‡ºç™»ï¿? : 'Successfully logged out',
          'info'
        );
      },
      
      // æ’­æ”¾éŸ³é¢‘é¢„è§ˆ
      playPreview: function(previewUrl, trackName) {
        if (!previewUrl) {
          this.showNotification(
            this.currentLanguage === 'zh' ? 'æ— æ³•æ’­æ”¾ï¼Œé¢„è§ˆé“¾æ¥ä¸å¯ç”¨' : 'Cannot play, preview link unavailable',
            'error'
          );
          return;
        }
        
        // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³ï¿?
        if (this.currentAudio) {
          this.currentAudio.pause();
          this.currentAudio = null;
        }
        
        // åˆ›å»ºæ–°éŸ³é¢‘å¯¹ï¿?
        const audio = new Audio(previewUrl);
        this.currentAudio = audio;
        
        // å¼€å§‹æ’­ï¿?
        audio.play().then(() => {
          this.showNotification(
            this.currentLanguage === 'zh' ? 'æ­£åœ¨æ’­æ”¾: ' + (trackName || 'éŸ³ä¹') : 'Now playing: ' + (trackName || 'music'),
            'info'
          );
        }).catch(error => {
          console.error('æ’­æ”¾éŸ³é¢‘å‡ºé”™:', error);
          this.showNotification(
            this.currentLanguage === 'zh' ? 'æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åå†è¯•' : 'Playback failed, please try again later',
            'error'
          );
        });
        
        // æ’­æ”¾ç»“æŸæ—¶æ¸…ï¿?
        audio.onended = () => {
          this.currentAudio = null;
        };
      },
      
      // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
      handleImageError: function(event) {
        event.target.src = 'static/img/music-pattern.svg';
      },
      
      // æ’­æ”¾æ­Œæ›²é¢„è§ˆ
      playSongPreview(previewUrl) {
        this.playPreview(previewUrl);
      },
      
      // å¯¹å•é¦–æ­Œæ›²è¯„ï¿?
      rateSongItem(song, rating) {
        if (!song || !song.track_id) return;
        
        // è®¾ç½®æ­Œæ›²è¯„åˆ†
        song.rating = rating;
        
        // è°ƒç”¨è¯„åˆ†API
        this.rateSong(song.track_id, rating);
      },
      
      // ç‚¹èµæ­Œæ›²
      likeSong(song) {
        if (!song || !song.track_id) return;
        
        this.submitFeedback(song.track_id, 'like');
        this.showNotification('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¿?, 'success');
      },
      
      // ç‚¹è¸©æ­Œæ›²
      dislikeSong(song) {
        if (!song || !song.track_id) return;
        
        this.submitFeedback(song.track_id, 'dislike');
        this.showNotification('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æˆ‘ä»¬ä¼šæ”¹è¿›æ¨è', 'info');
      },
      
      // åŠ è½½èŠå¤©å†å²
      loadChatHistory() {
        // å¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œä¸åŠ è½½èŠå¤©å†å²
        if (!this.user.isLoggedIn) return;
        
        // è°ƒç”¨è·å–èŠå¤©å†å²çš„API
        this.getChatHistory();
      },
      
      // ç§»é™¤é€šçŸ¥
      removeNotification(index) {
        this.notifications.splice(index, 1);
      },
      
      /**
       * è·³è½¬åˆ°é—®å·è°ƒæŸ¥é¡µï¿?
       */
      goToQuestionnaire() {
        // ä¿å­˜å½“å‰ç”¨æˆ·IDåˆ°æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿é—®å·é¡µé¢ä½¿ç”¨
        if (this.user && this.user.id) {
          localStorage.setItem('userId', this.user.id);
        }
        // è·³è½¬åˆ°é—®å·é¡µï¿?
        window.location.href = '/questionnaire';
      },
      
      /**
       * è·å–é€šçŸ¥å›¾æ ‡
       */
      getNotificationIcon(type) {
        switch(type) {
          case 'success':
            return 'fas fa-check-circle';
          case 'error':
            return 'fas fa-exclamation-circle';
          case 'warning':
            return 'fas fa-exclamation-triangle';
          default:
            return 'fas fa-info-circle';
        }
      },
      
      // æ·»åŠ é€šçŸ¥
      addNotification(message, type = 'is-info') {
        console.log("æ·»åŠ é€šçŸ¥:", message, type);
        if (!this.notifications) {
          this.notifications = [];
        }
        this.notifications.push({
          message: message,
          type: type
        });
        
        // åŒæ—¶æ›´æ–°å•ä¸€é€šçŸ¥å¯¹è±¡ï¼Œå…¼å®¹æ—§ä»£ç 
        this.notification = {
          message: message,
          type: type.replace('is-', ''),
          isVisible: true
        };
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
        setTimeout(() => {
          if (this.notifications && this.notifications.length > 0) {
            this.notifications.shift();
          }
          this.notification.isVisible = false;
        }, 3000);
      },
      
      // åŠ è½½ç”¨æˆ·è¯„åˆ†è®°å½•
      loadUserRatings() {
        if (!this.user.isLoggedIn) return;
        
        this.isLoading = true;
        
        axios.get(`/api/user_ratings/${this.user.id}`)
          .then(response => {
            this.userRatings = response.data || {};
            console.log('å·²åŠ è½½ç”¨æˆ·è¯„ï¿?', Object.keys(this.userRatings).length);
          })
          .catch(error => {
            console.error('åŠ è½½ç”¨æˆ·è¯„åˆ†å¤±è´¥:', error);
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // åŠ è½½æ‰€æœ‰ç”¨ï¿?(ç®¡ç†å‘˜åŠŸï¿?
      loadAllUsers() {
        if (!this.user.isDeveloper) {
          this.showNotification('åªæœ‰å¼€å‘è€…æ‰èƒ½æŸ¥çœ‹ç”¨æˆ·åˆ—ï¿?, 'warning');
          this.currentTab = 'home';
          return;
        }
        
        this.isLoading = true;
        
        axios.get(`/api/user/all?admin_id=${this.user.id}`)
          .then(response => {
            this.allUsers = response.data || [];
            console.log('å·²åŠ è½½æ‰€æœ‰ç”¨ï¿?', this.allUsers.length);
          })
          .catch(error => {
            console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            this.showNotification('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // æ·»åŠ æ–°ç”¨ï¿?(ç®¡ç†å‘˜åŠŸï¿?
      addUser() {
        if (!this.user.isDeveloper) {
          this.showNotification('åªæœ‰å¼€å‘è€…æ‰èƒ½æ·»åŠ ç”¨ï¿?, 'warning');
          return;
        }
        
        if (!this.newUser.username.trim()) {
          this.showNotification('è¯·è¾“å…¥ç”¨æˆ·å', 'warning');
          return;
        }
        
        if (!this.newUser.password.trim()) {
          this.showNotification('è¯·è¾“å…¥å¯†ï¿?, 'warning');
          return;
        }
        
        this.isLoading = true;
        
        // å‡†å¤‡æ·»åŠ ç”¨æˆ·çš„æ•°ï¿?
        const userData = {
          admin_id: this.user.id,
          username: this.newUser.username,
          password: this.newUser.password,
          email: this.newUser.email,
          is_developer: this.newUser.isDeveloper
        };
        
        axios.post('/api/user/register', userData)
          .then(response => {
            console.log('æ·»åŠ ç”¨æˆ·æˆåŠŸ:', response.data);
            this.showNotification('æ·»åŠ ç”¨æˆ·æˆåŠŸ', 'success');
            
            // é‡ç½®è¡¨å•
            this.newUser = {
              username: '',
              email: '',
              password: '',
              isDeveloper: false
            };
            
            // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
            this.loadAllUsers();
          })
          .catch(error => {
            console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            if (error.response && error.response.data && error.response.data.error) {
              this.showNotification(error.response.data.error, 'error');
            } else {
              this.showNotification('æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
      
      // ç¼–è¾‘ç”¨æˆ· (ç®¡ç†å‘˜åŠŸï¿?
      editUser(user) {
        this.editingUser = { ...user };
        
        // è¿™é‡Œå¯ä»¥æ‰“å¼€ä¸€ä¸ªç¼–è¾‘æ¨¡æ€æ¡†
        // ä¸ºç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºä¸€æ¡æ¶ˆï¿?
        console.log('ç¼–è¾‘ç”¨æˆ·:', this.editingUser);
        this.showNotification('ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å¾…å®ï¿?, 'info');
      },
      
      // åˆ é™¤ç”¨æˆ· (ç®¡ç†å‘˜åŠŸï¿?
      deleteUser(user) {
        if (user.id === 'dev-001') {
          this.showNotification('ä¸èƒ½åˆ é™¤ä¸»å¼€å‘è€…è´¦ï¿?, 'warning');
          return;
        }
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨ï¿?${user.username} å—ï¼Ÿ`)) {
          this.isLoading = true;
          
          axios.delete(`/api/user/delete?admin_id=${this.user.id}&user_id=${user.id}`)
            .then(response => {
              console.log('åˆ é™¤ç”¨æˆ·æˆåŠŸ:', response.data);
              this.showNotification('åˆ é™¤ç”¨æˆ·æˆåŠŸ', 'success');
              
              // ä»åˆ—è¡¨ä¸­ç§»é™¤è¯¥ç”¨ï¿?
              this.allUsers = this.allUsers.filter(u => u.id !== user.id);
            })
            .catch(error => {
              console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
              this.showNotification('åˆ é™¤ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            })
            .finally(() => {
              this.isLoading = false;
            });
        }
      },
      
      /**
       * ç”¨æˆ·ç™»å‡º
       */
      logout: function() {
        console.log("æ‰§è¡Œç™»å‡ºæ“ä½œ");
        // è°ƒç”¨logoutUseræ–¹æ³•
        this.logoutUser();
        
        // æ¸…é™¤æ‰€æœ‰ç›¸å…³å­˜ï¿?
        localStorage.removeItem('user');
        localStorage.removeItem('user_session');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        localStorage.removeItem('email');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('isDeveloper');
        
        // é‡ç½®ç”¨æˆ·ç›¸å…³å­—æ®µ
        this.username = '';
        this.email = '';
        this.password = '';
        
        // æ·»åŠ ç™»å‡ºæˆåŠŸé€šçŸ¥
        this.addNotification(
          this.currentLanguage === 'zh' ? 'å·²æˆåŠŸé€€å‡ºç™»ï¿? : 'Successfully logged out',
          'is-success'
        );
        
        console.log("ç™»å‡ºå®Œæˆï¼Œç”¨æˆ·çŠ¶æ€ï¼š", this.user);
      },
      
      // æŸ¥æ‰¾å¹¶æ’­æ”¾æ­Œæ›²é¢„ï¿?
      playSongPreview(previewUrl) {
        console.log("å°è¯•æ’­æ”¾é¢„è§ˆ:", previewUrl);
        
        if (!previewUrl || previewUrl === "") {
          this.showNotification("æŠ±æ­‰ï¼Œè¯¥æ­Œæ›²æ²¡æœ‰å¯ç”¨çš„é¢„è§ˆï¿½?, "warning");
          return;
        }
        
        // ä½¿ç”¨ç°æœ‰çš„éŸ³é¢‘å…ƒç´ è€Œä¸æ˜¯åˆ›å»ºæ–°ï¿?
        const audioPlayer = document.getElementById('audio-player');
        if (!audioPlayer) {
          console.error("æ‰¾ä¸åˆ°éŸ³é¢‘æ’­æ”¾å™¨å…ƒç´ ");
          this.showNotification("éŸ³é¢‘æ’­æ”¾å™¨åŠ è½½å¤±ï¿?, "error");
          return;
        }
        
        // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
        audioPlayer.src = previewUrl;
        audioPlayer.style.display = 'block'; // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾ï¿?
        
        // æ’­æ”¾å¤±è´¥æ—¶æ˜¾ç¤ºé”™ï¿?
        audioPlayer.onerror = (e) => {
          console.error("éŸ³é¢‘æ’­æ”¾é”™è¯¯:", e);
          this.showNotification("æ’­æ”¾é¢„è§ˆæ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ï¿½?, "error");
        };
        
        // å°è¯•æ’­æ”¾
        try {
          const playPromise = audioPlayer.play();
          
          if (playPromise !== undefined) {
            playPromise.then(() => {
              this.showNotification("å¼€å§‹æ’­æ”¾é¢„ï¿?, "success");
            }).catch(error => {
              console.error("æ’­æ”¾å¤±è´¥:", error);
              this.showNotification("æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œè¯·ç‚¹å‡»é¡µé¢åå†ï¿?, "warning");
            });
          }
        } catch (e) {
          console.error("æ’­æ”¾å¼‚å¸¸:", e);
          this.showNotification("æ’­æ”¾å‡ºç°å¼‚å¸¸", "error");
        }
        
        // æ’­æ”¾å®Œæˆåéšè—æ’­æ”¾å™¨
        audioPlayer.onended = () => {
          audioPlayer.style.display = 'none';
        };
      },
      
      // æ ¼å¼åŒ–èŠå¤©æ¶ˆæ¯ï¼Œæ£€æµ‹å¹¶è½¬æ¢éŸ³ä¹é“¾æ¥ä¸ºå¯ç‚¹å‡»çš„æ’­æ”¾æŒ‰ï¿?
      formatChatMessage(message) {
        // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«é¢„è§ˆURLçš„æ¨¡ï¿?
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        const spotifyPattern = /(https?:\/\/(?:open\.spotify\.com|api\.spotify\.com)[^\s]+)/g;
        
        // æ›¿æ¢Spotifyé“¾æ¥ä¸ºå¯ç‚¹å‡»çš„æ’­æ”¾æŒ‰ï¿?
        if (spotifyPattern.test(message)) {
            return message.replace(spotifyPattern, url => {
                return `<div class="music-preview-link">
                        <a href="${url}" target="_blank" class="music-link">${url}</a>
                        <button class="button is-small is-primary play-button" onclick="app.playSongPreview('${url}')">
                            <span class="icon"><i class="fas fa-play"></i></span> æ’­æ”¾
                        </button>
                    </div>`;
            });
        }
        
        // æ›¿æ¢æ™®é€šURLä¸ºå¯ç‚¹å‡»é“¾æ¥
        if (urlPattern.test(message)) {
            return message.replace(urlPattern, url => {
                // æ£€æŸ¥URLæ˜¯å¦ä¸ºéŸ³é¢‘æ ¼ï¿?
                if (url.match(/\.(mp3|wav|ogg)$/i)) {
                    return `<div class="music-preview-link">
                            <a href="${url}" target="_blank" class="music-link">${url}</a>
                            <button class="button is-small is-primary play-button" onclick="app.playSongPreview('${url}')">
                                <span class="icon"><i class="fas fa-play"></i></span> æ’­æ”¾
                            </button>
                        </div>`;
                } else {
                    return `<a href="${url}" target="_blank">${url}</a>`;
                }
            });
        }
        
        return message;
      },
      
      // æ·»åŠ åˆ°æ¶ˆæ¯å†å²å¹¶æ˜¾ç¤º
      addChatMessage(message, isUser = false) {
        // æ ¼å¼åŒ–æ¶ˆæ¯ä¸­çš„é“¾ï¿?
        const formattedContent = isUser ? message : this.formatChatMessage(message);
        
        this.chatMessages.push({
            content: formattedContent,
            isUser: isUser,
            time: new Date().toLocaleTimeString()
        });
        
        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆï¿?
        this.$nextTick(() => {
            const chatContainer = this.$refs.chatMessages;
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });
      },
      
      // ä¿å­˜èŠå¤©è®°å½•
      saveChatHistory() {
        // å°†èŠå¤©è®°å½•ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('chatHistory', JSON.stringify(this.chatHistory));
      },
      
      // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«æƒ…ç»ªå…³é”®è¯
      containsEmotionKeywords(message) {
        return this.emotionKeywords.some(keyword => message.includes(keyword));
      },
      
      setupEventListeners() {
        console.log('è®¾ç½®æ¸¸æˆäº‹ä»¶ç›‘å¬ï¿?..');
        
        // ç§»é™¤ä»¥å‰çš„äº‹ä»¶ç›‘å¬å™¨
        if (this._keydownHandler) {
          document.removeEventListener('keydown', this._keydownHandler);
          console.log('å·²ç§»é™¤æ—§çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨');
        }
        
        // å¦‚æœå·²ç»è®¾ç½®è¿‡äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸è¦é‡å¤è®¾ç½®æŒ‰é’®äº‹ï¿?
        if (this._eventListenersSet) {
          // åªé‡æ–°ç»‘å®šé”®ç›˜äº‹ï¿?
          this._keydownHandler = this._createKeydownHandler();
          document.addEventListener('keydown', this._keydownHandler);
          console.log('å·²æ·»åŠ æ–°çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨');
          return;
        }
        
        // é”®ç›˜æ§åˆ¶
        this._keydownHandler = this._createKeydownHandler();
        
        // æ·»åŠ é”®ç›˜äº‹ä»¶ï¼Œç¡®ä¿åœ¨æ•´ä¸ªæ–‡æ¡£ä¸Šç›‘ï¿?
        document.addEventListener('keydown', this._keydownHandler);
        console.log('å·²æ·»åŠ æ–°çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨');
        
        // å¼€å§‹æ¸¸æˆæŒ‰ï¿?
        const startButton = document.getElementById('game-start');
        console.log('æŸ¥æ‰¾å¼€å§‹æ¸¸æˆæŒ‰ï¿?', startButton ? 'æˆåŠŸ' : 'å¤±è´¥');
        
        if (startButton) {
          console.log('æ‰¾åˆ°å¼€å§‹æ¸¸æˆæŒ‰é’®ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶...');
          // ç§»é™¤æ‰€æœ‰ç°æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡ï¿?
          const newStartButton = startButton.cloneNode(true);
          startButton.parentNode.replaceChild(newStartButton, startButton);
          
          // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶å¤„ç†ç¨‹åº
          this._startButtonHandler = (e) => {
            console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»!', e);
            e.preventDefault();
            e.stopPropagation();
            this.startGame();
          };
          
          // åŒæ—¶æ·»åŠ é¼ æ ‡ç‚¹å‡»å’Œè§¦æ‘¸äº‹ä»¶ï¼Œå¢åŠ å…¼å®¹ï¿?
          newStartButton.addEventListener('click', this._startButtonHandler);
          newStartButton.addEventListener('touchend', this._startButtonHandler);
          
          // æ·»åŠ é¢å¤–çš„è°ƒè¯•ä¿¡ï¿?
          newStartButton.style.pointerEvents = 'auto';
          newStartButton.style.cursor = 'pointer';
          newStartButton.setAttribute('data-listener-set', 'true');
          
          // æ·»åŠ å†…è”ç‚¹å‡»äº‹ä»¶ï¼Œä½œä¸ºå¤‡ï¿?
          newStartButton.onclick = (e) => {
            console.log('æ¸¸æˆæŒ‰é’®å†…è”ç‚¹å‡»äº‹ä»¶è§¦å‘');
            this._startButtonHandler(e);
          };
          
          // å¼ºè°ƒæŒ‰é’®å¯ç‚¹å‡»ï¿½?
          newStartButton.style.zIndex = '1000';
          
          console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶å·²è®¾ç½®');
        } else {
          console.error('æ‰¾ä¸åˆ°å¼€å§‹æ¸¸æˆæŒ‰ï¿?');
        }
        
        // å®Œæˆæ¸¸æˆæŒ‰é’®
        const finishButton = document.getElementById('game-finish');
        if (finishButton) {
          const newFinishButton = finishButton.cloneNode(true);
          finishButton.parentNode.replaceChild(newFinishButton, finishButton);
          
          this._finishButtonHandler = () => {
            // é€€å‡ºå…¨ï¿?
            if (document.fullscreenElement) {
              document.exitFullscreen().catch(err => {
                console.error('æ— æ³•é€€å‡ºå…¨å±æ¨¡ï¿?', err);
              });
            }
            
            this.finishGame();
          };
          
          newFinishButton.addEventListener('click', this._finishButtonHandler);
          newFinishButton.setAttribute('data-listener-set', 'true');
        }
        
        this._eventListenersSet = true;
      },
      
      // åˆ›å»ºé”®ç›˜äº‹ä»¶å¤„ç†å‡½æ•°
      _createKeydownHandler() {
        return (e) => {
          console.log('é”®ç›˜äº‹ä»¶:', e.key, 'æ¸¸æˆè¿è¡ŒçŠ¶ï¿½?', this.gameRunning);
          
          if (!this.gameRunning || !this.player) return;
          
          // ä¸ºäº†å¢åŠ è¿åŠ¨çš„å“åº”æ€§ï¼Œæˆ‘ä»¬ç«‹å³æ›´æ–°ç©å®¶ä½ç½®å¹¶é‡ï¿?
          let needsRedraw = false;
          
          if (e.key === 'ArrowLeft') {
            this.player.x -= this.player.speed;
            console.log('ç©å®¶å·¦ç§»:', this.player.x);
            needsRedraw = true;
          }
          
          if (e.key === 'ArrowRight') {
            this.player.x += this.player.speed;
            console.log('ç©å®¶å³ç§»:', this.player.x);
            needsRedraw = true;
          }
          
          if (e.key === 'ArrowUp' && this.player.grounded) {
            this.player.dy = -12; // è·³è·ƒåŠ›åº¦
            this.player.grounded = false;
            console.log('ç©å®¶è·³è·ƒ:', this.player.dy);
            needsRedraw = true;
          }
          
          // ç¡®ä¿ç©å®¶ä¸ä¼šè¶…å‡ºç”»å¸ƒ
          if (this.player.x < 0) this.player.x = 0;
          if (this.player.x + this.player.width > this.canvas.width) {
            this.player.x = this.canvas.width - this.player.width;
          }
          
          // æŒ‰ESCé”®é€€å‡ºå…¨ï¿?
          if (e.key === 'Escape' && document.fullscreenElement) {
            document.exitFullscreen().catch(err => {
              console.error('æ— æ³•é€€å‡ºå…¨å±æ¨¡ï¿?', err);
            });
          }
          
          // å¦‚æœæœ‰ä½ç½®æ›´æ–°ï¼Œç«‹å³é‡ç»˜æ¸¸æˆç”»é¢
          if (needsRedraw && this.canvas && this.ctx) {
            // å¼ºåˆ¶é‡ç»˜ä¸€ï¿?
            cancelAnimationFrame(this._gameLoopId);
            this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
          }
        };
      },
      
      updatePreferenceDisplay() {
        try {
          const list = document.getElementById('preference-list');
          if (!list) {
            console.log('åå¥½åˆ—è¡¨å…ƒç´ ä¸å­˜ï¿?);
            return;
          }
          
          // æ¸…ç©ºåˆ—è¡¨
          list.innerHTML = '';
          
          // è·å–å”¯ä¸€åå¥½
          const uniquePreferences = [...new Set(this.preferences)];
          
          // ä¸ºæ¯ä¸ªåå¥½åˆ›å»ºä¸€ä¸ªåˆ—è¡¨é¡¹
          uniquePreferences.forEach(prefName => {
            // æ‰¾åˆ°å¯¹åº”çš„éŸ³ä¹é£ï¿?
            const genre = this.findGenreByName(prefName);
            
            const item = document.createElement('li');
            
            if (genre) {
              // å¦‚æœæ‰¾åˆ°äº†é£æ ¼ä¿¡æ¯ï¼Œä½¿ç”¨è¯¦ç»†ä¿¡æ¯
              item.innerHTML = `${genre.icon} ${prefName}`;
              item.style.backgroundColor = genre.color;
            } else {
              // å¦åˆ™åªæ˜¾ç¤ºåï¿?
              item.innerHTML = prefName;
              item.style.backgroundColor = '#333333';
            }
            
            // æ·»åŠ æ ·å¼
            item.style.padding = '8px 12px';
            item.style.margin = '5px 0';
            item.style.borderRadius = '4px';
            item.style.color = 'white';
            item.style.listStyleType = 'none';
            
            list.appendChild(item);
          });
          
          // å¦‚æœæ”¶é›†äº†è¶³å¤Ÿçš„åå¥½ï¼Œæ˜¾ç¤ºå®ŒæˆæŒ‰ï¿?
          if (uniquePreferences.length >= 5) {
            const finishButton = document.getElementById('game-finish');
            if (finishButton) {
              finishButton.classList.remove('is-hidden');
            }
          }
        } catch (error) {
          console.error('æ›´æ–°åå¥½æ˜¾ç¤ºæ—¶å‡ºï¿?', error);
        }
      },
      
      // é€šè¿‡åç§°æŸ¥æ‰¾éŸ³ä¹é£æ ¼
      findGenreByName(name) {
        const genres = [
          { name: 'æµè¡ŒéŸ³ä¹', icon: 'ğŸµ', color: '#FF5733' },
          { name: 'æ‘‡æ»š', icon: 'ğŸ¤˜', color: '#C70039' },
          { name: 'å¤å…¸', icon: 'ğŸ»', color: '#900C3F' },
          { name: 'çˆµå£«', icon: 'ğŸ·', color: '#581845' },
          { name: 'ç”µå­', icon: 'ğŸ§', color: '#FFC300' },
          { name: 'å˜»å“ˆ', icon: 'ğŸ¤', color: '#DAF7A6' },
          { name: 'æ°‘è°£', icon: 'ğŸª•', color: '#FF5733' },
          { name: 'è“è°ƒ', icon: 'ğŸ¸', color: '#C70039' }
        ];
        
        return genres.find(genre => genre.name === name);
      },
      
      // æ¸¸æˆå¾ªç¯
      gameLoop() {
        try {
          // ç¡®ä¿å¿…è¦çš„å¯¹è±¡å­˜ï¿?
          if (!this.canvas || !this.ctx || !this.player) {
            console.error('gameLoop: ç¼ºå°‘å¿…è¦å¯¹è±¡', {
              canvas: !!this.canvas,
              ctx: !!this.ctx,
              player: !!this.player
            });
            return;
          }
          
          // æ¸…é™¤ç”»å¸ƒ
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          
          // ç»˜åˆ¶èƒŒæ™¯ - æ·»åŠ èƒŒæ™¯è‰²ä»¥é¿å…é»‘å±
          this.ctx.fillStyle = '#191919';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // ç»˜åˆ¶åœ°é¢
          this.ctx.fillStyle = '#333';
          this.ctx.fillRect(0, this.ground + this.player.height, this.canvas.width, 2);
          
          // å¦‚æœæ¸¸æˆå·²æš‚åœï¼Œæ˜¾ç¤ºæš‚åœå±å¹•
          if (this.gamePaused) {
            this.drawPauseScreen();
            return;
          }
          
          // å¦‚æœæ¸¸æˆå·²å®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆå±å¹•
          if (this.gameCompleted) {
            this.showFinishScreen();
            return;
          }
          
          // æ›´æ–°ç©å®¶
          this.updatePlayer();
          
          // æ›´æ–°æ”¶é›†ç‰©ä½ï¿?
          this.updateCollectibles();
          
          // æ£€æŸ¥ç¢°ï¿?
          this.checkCollisions();
          
          // æ›´æ–°ç²’å­æ•ˆæœ
          if (typeof this.updateParticles === 'function') {
            this.updateParticles();
          }
          
          // ç»˜åˆ¶ç©å®¶
          this.drawPlayer();
          
          // ç»˜åˆ¶æ”¶é›†ï¿?
          this.drawCollectibles();
          
          // ç»˜åˆ¶ç²’å­æ•ˆæœ
          if (typeof this.drawParticles === 'function') {
            this.drawParticles();
          }
          
          // ç»˜åˆ¶åˆ†æ•°
          this.drawScore();
          
          // ç»˜åˆ¶åå¥½æ˜¾ç¤º
          if (typeof this.drawPreferences === 'function') {
            this.drawPreferences();
          }
          
          // ç»§ç»­æ¸¸æˆå¾ªç¯
          if (this.gameRunning) {
            this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
          }
        } catch (error) {
          console.error('æ¸¸æˆå¾ªç¯ä¸­å‡ºï¿?', error);
          
          // å°è¯•æ¢å¤æ¸¸æˆè¿è¡Œ
          if (this.gameRunning) {
            setTimeout(() => {
              this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
            }, 1000);
          }
        }
      },
      
      // ç»˜åˆ¶åå¥½
      drawPreferences() {
        try {
          if (!this.ctx) return;
          
          this.ctx.fillStyle = 'white';
          this.ctx.font = '16px Arial';
          this.ctx.textAlign = 'left';
          this.ctx.fillText('å·²æ”¶é›†çš„éŸ³ä¹åå¥½:', 10, 30);
          
          // æ˜¾ç¤ºï¿?ä¸ªå·²æ”¶é›†çš„åï¿?
          const uniquePreferences = [...new Set(this.preferences)];
          const displayPreferences = uniquePreferences.slice(0, 5);
          
          displayPreferences.forEach((pref, index) => {
            // æ‰¾åˆ°å¯¹åº”çš„éŸ³ä¹é£ï¿?
            const genre = this.findGenreByName(pref);
            
            // ç»˜åˆ¶èƒŒæ™¯
            if (genre) {
              this.ctx.fillStyle = genre.color;
            } else {
              this.ctx.fillStyle = '#333333';
            }
            
            this.ctx.fillRect(10, 40 + index * 25, 150, 20);
            
            // ç»˜åˆ¶æ–‡å­—
            this.ctx.fillStyle = 'white';
            this.ctx.font = '14px Arial';
            
            // å¦‚æœæœ‰å›¾æ ‡ï¼Œç»˜åˆ¶å›¾æ ‡å’Œåï¿?
            if (genre) {
              this.ctx.fillText(`${genre.icon} ${pref}`, 15, 55 + index * 25);
            } else {
              this.ctx.fillText(pref, 15, 55 + index * 25);
            }
          });
          
          // å¦‚æœæœ‰æ›´å¤šåå¥½ï¼Œæ˜¾ç¤º"æŸ¥çœ‹æ›´å¤š"
          if (uniquePreferences.length > 5) {
            this.ctx.fillStyle = 'yellow';
            this.ctx.fillText(`+ è¿˜æœ‰ ${uniquePreferences.length - 5} é¡¹`, 15, 60 + 5 * 25);
          }
        } catch (error) {
          console.error('ç»˜åˆ¶åå¥½æ—¶å‡ºï¿?', error);
        }
      },
      
      // æ·»åŠ æš‚åœç”»é¢ç»˜åˆ¶
      drawPauseScreen() {
        try {
          if (!this.ctx || !this.canvas) return;
          
          // ç»˜åˆ¶åŠé€æ˜èƒŒæ™¯
          this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
          
          // ç»˜åˆ¶æš‚åœæ–‡å­—
          this.ctx.fillStyle = '#ffffff';
          this.ctx.font = 'bold 36px Arial';
          this.ctx.textAlign = 'center';
          this.ctx.fillText('æ¸¸æˆæš‚åœ', this.canvas.width / 2, this.canvas.height / 2);
          
          // ç»˜åˆ¶æç¤ºä¿¡æ¯
          this.ctx.font = '20px Arial';
          this.ctx.fillText('æŒ‰ç©ºæ ¼é”®ç»§ç»­', this.canvas.width / 2, this.canvas.height / 2 + 40);
          
          // ç»˜åˆ¶å·²æ”¶é›†çš„åå¥½
          this.drawPreferences();
        } catch (error) {
          console.error('ç»˜åˆ¶æš‚åœç”»é¢æ—¶å‡ºï¿?', error);
        }
      },
      
      // æ·»åŠ ç²’å­æ•ˆæœåˆ›å»º
      createParticles(x, y, color = '#ffff00') {
        if (!this.particles) this.particles = [];
        
        // åˆ›å»ºçˆ†å‘æ•ˆæœçš„ç²’ï¿?
        for (let i = 0; i < 15; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 3 + 1;
          
          this.particles.push({
            x,
            y,
            radius: Math.random() * 4 + 1,
            color,
            speedX: Math.cos(angle) * speed,
            speedY: Math.sin(angle) * speed,
            life: 30 + Math.random() * 20
          });
        }
      },
      
      // æ›´æ–°ç²’å­æ•ˆæœ
      updateParticles() {
        if (!this.particles || !Array.isArray(this.particles)) return;
        
        for (let i = 0; i < this.particles.length; i++) {
          let p = this.particles[i];
          
          // æ›´æ–°ç²’å­ä½ç½®
          p.x += p.speedX;
          p.y += p.speedY;
          
          // è¾¹ç•Œæ£€æŸ?
          if (p.x < 0 || p.x > this.canvas.width) {
            p.speedX *= -1;
          }
          
          
          if (p.y < 0 || p.y > this.canvas.height) {
            p.speedY *= -1;
          }
        }
      },
      
      // ç»˜åˆ¶ç²’å­æ•ˆæœ
      drawParticles() {
        if (!this.ctx || !this.particles) return;
        
        this.particles.forEach(particle => {
          // è®¾ç½®é€æ˜åº¦æ ¹æ®ç”Ÿå‘½ï¿½?
          const alpha = particle.life / 50;
          
          this.ctx.globalAlpha = alpha;
          this.ctx.fillStyle = particle.color;
          
          // ç»˜åˆ¶åœ†å½¢ç²’å­
          this.ctx.beginPath();
          this.ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
          this.ctx.fill();
          
          // é‡ç½®é€æ˜ï¿?
          this.ctx.globalAlpha = 1;
        });
      },
      
      // æ¸¸æˆå¯åŠ¨æ–¹æ³•
      startGame() {
        try {
          console.log('æ¸¸æˆå¼€ï¿?');
          
          // å¦‚æœæ²¡æœ‰canvasæˆ–ä¸Šä¸‹æ–‡ï¼Œå°è¯•å†æ¬¡åˆå§‹åŒ–
          if (!this.canvas || !this.ctx) {
            console.log('æ¸¸æˆæœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–');
            if (!this.init()) {
              console.error('æ— æ³•åˆå§‹åŒ–æ¸¸ï¿?');
              return;
            }
          }
          
          // ç¡®ä¿playerå¯¹è±¡å·²åˆå§‹åŒ–
          if (!this.player) {
            console.log('ç©å®¶å¯¹è±¡æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆ›å»ºç©ï¿?);
            this.player = {
              x: 100,
              y: 300,
              width: 40,
              height: 40,
              speed: 5,
              dy: 0,
              jumping: false,
              grounded: true
            };
            this.ground = this.canvas.height - this.player.height;
          } else {
            // é‡ç½®ç©å®¶ä½ç½®
            this.player.x = 100;
            this.player.y = 300;
            this.player.dy = 0;
            this.player.grounded = true;
          }
          
          // è¿›å…¥å…¨å±æ¨¡å¼
          this.toggleFullscreen();
          
          this.gameRunning = true;
          this.gamePaused = false;
          this.gameCompleted = false;
          
          // æ·»åŠ é‡åŠ›å‚æ•°
          this.gravity = 0.5;
          
          // å®šä¹‰éŸ³ä¹é£æ ¼åˆ—è¡¨ï¼Œç¡®ä¿å­˜ï¿?
          this.genres = [
            { name: 'æµè¡ŒéŸ³ä¹', icon: 'ğŸµ', color: '#FF5733' },
            { name: 'æ‘‡æ»š', icon: 'ğŸ¤˜', color: '#C70039' },
            { name: 'å¤å…¸', icon: 'ğŸ»', color: '#900C3F' },
            { name: 'çˆµå£«', icon: 'ğŸ·', color: '#581845' },
            { name: 'ç”µå­', icon: 'ğŸ§', color: '#FFC300' },
            { name: 'å˜»å“ˆ', icon: 'ğŸ¤', color: '#DAF7A6' },
            { name: 'æ°‘è°£', icon: 'ğŸª•', color: '#FF5733' },
            { name: 'è“è°ƒ', icon: 'ğŸ¸', color: '#C70039' }
          ];
          
          // åˆå§‹åŒ–æˆ–ä¿ç•™ä¹‹å‰çš„ç”¨æˆ·åï¿?
          if (!this.preferences || this.preferences.length === 0) {
            this.preferences = [];
            // åŠ è½½ä¹‹å‰ä¿å­˜çš„åï¿?
            if (typeof this.loadUserPreferences === 'function') {
              this.loadUserPreferences();
            }
          }
          
          // é‡ç½®æ”¶é›†ç‰©å’Œåˆ†æ•°
          this.collectibles = [];
          this.particles = [];
          this.score = 0;
          
          // ç”Ÿæˆæ”¶é›†ï¿?
          this.generateCollectibles();
          
          // æ›´æ–°åå¥½æ˜¾ç¤ºï¼Œå¦‚æœæ–¹æ³•å­˜ï¿?
          if (typeof this.updatePreferenceDisplay === 'function') {
            this.updatePreferenceDisplay();
          }
          
          // å¯åŠ¨æ¸¸æˆå¾ªç¯
          if (this._gameLoopId) {
            cancelAnimationFrame(this._gameLoopId);
          }
          
          // ç«‹å³æ‰§è¡Œä¸€æ¬¡ç»˜åˆ¶ï¼Œç¡®ä¿å±å¹•ä¸æ˜¯é»‘çš„
          this.gameLoop();
          
          // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºå®ŒæˆæŒ‰é’®
          const startButton = document.getElementById('game-start');
          if (startButton) {
            startButton.disabled = true;
            console.log('å·²ç¦ç”¨å¼€å§‹æ¸¸æˆæŒ‰ï¿?);
          }
          
          // ç¡®ä¿å®ŒæˆæŒ‰é’®éšè—
          const finishButton = document.getElementById('game-finish');
          if (finishButton) {
            finishButton.classList.add('is-hidden');
            console.log('å·²éšè—å®Œæˆæ¸¸æˆæŒ‰ï¿?);
          }
          
          // é‡æ–°ç»‘å®šé”®ç›˜äº‹ä»¶
          this.setupEventListeners();
          
          console.log('æ¸¸æˆå¯åŠ¨æˆåŠŸ!');
          console.log('è¯·ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨: ï¿?ï¿?å·¦å³ç§»åŠ¨, ï¿?è·³è·ƒ');
        } catch (error) {
          console.error('å¯åŠ¨æ¸¸æˆæ—¶å‡ºï¿?', error);
        }
      },
      
      // ä¿®æ”¹é”®ç›˜äº‹ä»¶å¤„ç†å™¨ï¼Œæ·»åŠ æš‚åœåŠŸèƒ½
      _createKeydownHandler() {
        return (e) => {
          console.log('é”®ç›˜äº‹ä»¶:', e.key, 'æ¸¸æˆè¿è¡ŒçŠ¶ï¿½?', this.gameRunning);
          
          if (!this.gameRunning) return;
          
          // ç©ºæ ¼é”®æš‚ï¿?ç»§ç»­æ¸¸æˆ
          if (e.key === ' ' || e.code === 'Space') {
            this.gamePaused = !this.gamePaused;
            console.log(this.gamePaused ? 'æ¸¸æˆå·²æš‚ï¿? : 'æ¸¸æˆå·²ç»§ï¿?);
            
            // å¦‚æœç»§ç»­æ¸¸æˆï¼Œç«‹å³å¯åŠ¨æ¸¸æˆå¾ªï¿?
            if (!this.gamePaused) {
              cancelAnimationFrame(this._gameLoopId);
              this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
            }
            return;
          }
          
          // å¦‚æœæ¸¸æˆæš‚åœï¼Œä¸å¤„ç†å…¶ä»–æŒ‰é”®
          if (this.gamePaused || !this.player) return;
          
          // ä¸ºäº†å¢åŠ è¿åŠ¨çš„å“åº”æ€§ï¼Œæˆ‘ä»¬ç«‹å³æ›´æ–°ç©å®¶ä½ç½®å¹¶é‡ï¿?
          let needsRedraw = false;
          
          if (e.key === 'ArrowLeft') {
            this.player.x -= this.player.speed;
            console.log('ç©å®¶å·¦ç§»:', this.player.x);
            needsRedraw = true;
          }
          
          if (e.key === 'ArrowRight') {
            this.player.x += this.player.speed;
            console.log('ç©å®¶å³ç§»:', this.player.x);
            needsRedraw = true;
          }
          
          if (e.key === 'ArrowUp' && this.player.grounded) {
            this.player.dy = -12; // è·³è·ƒåŠ›åº¦
            this.player.grounded = false;
            console.log('ç©å®¶è·³è·ƒ:', this.player.dy);
            needsRedraw = true;
          }
          
          // ç¡®ä¿ç©å®¶ä¸ä¼šè¶…å‡ºç”»å¸ƒ
          if (this.player.x < 0) this.player.x = 0;
          if (this.player.x + this.player.width > this.canvas.width) {
            this.player.x = this.canvas.width - this.player.width;
          }
          
          // æŒ‰ESCé”®é€€å‡ºå…¨ï¿?
          if (e.key === 'Escape' && document.fullscreenElement) {
            document.exitFullscreen().catch(err => {
              console.error('æ— æ³•é€€å‡ºå…¨å±æ¨¡ï¿?', err);
            });
          }
          
          // å¦‚æœæœ‰ä½ç½®æ›´æ–°ï¼Œç«‹å³é‡ç»˜æ¸¸æˆç”»é¢
          if (needsRedraw && this.canvas && this.ctx) {
            // å¼ºåˆ¶é‡ç»˜ä¸€ï¿?
            cancelAnimationFrame(this._gameLoopId);
            this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
          }
        };
      },
      
      // ç»˜åˆ¶ç©å®¶
      drawPlayer() {
        try {
          if (!this.ctx || !this.player) {
            console.error('drawPlayer: ç¼ºå°‘å¿…è¦å¯¹è±¡', {
              ctx: !!this.ctx,
              player: !!this.player
            });
            return;
          }
          
          // ç©å®¶è§’è‰²
          this.ctx.fillStyle = 'red';  // æ›´é²œè‰³çš„é¢œè‰²ï¼Œä¾¿äºè¯†ï¿?
          this.ctx.fillRect(
            this.player.x,
            this.player.y,
            this.player.width,
            this.player.height
          );
          
          // æ·»åŠ ç©å®¶è½®å»“ï¼Œæ›´å®¹æ˜“çœ‹è§
          this.ctx.strokeStyle = 'white';
          this.ctx.lineWidth = 2;
          this.ctx.strokeRect(
            this.player.x,
            this.player.y,
            this.player.width,
            this.player.height
          );
          
          // æ·»åŠ çœ¼ç›ï¼Œè®©ç©å®¶çœ‹èµ·æ¥æ›´ç”ŸåŠ¨
          this.ctx.fillStyle = 'white';
          this.ctx.fillRect(
            this.player.x + 8, 
            this.player.y + 10,
            6,
            6
          );
          this.ctx.fillRect(
            this.player.x + this.player.width - 14, 
            this.player.y + 10,
            6,
            6
          );
        } catch (error) {
          console.error('ç»˜åˆ¶ç©å®¶æ—¶å‡ºï¿?', error);
        }
      },
      
      // ä¿®æ”¹æ”¶é›†ç‰©ç»˜åˆ¶æ–¹æ³•ï¼Œç¡®ä¿å¯è§
      drawCollectibles() {
        try {
          // ç¡®ä¿collectiblesæ•°ç»„å­˜åœ¨
          if (!this.collectibles || !this.ctx) {
            console.error('drawCollectibles: ç¼ºå°‘å¿…è¦å¯¹è±¡', {
              collectibles: !!this.collectibles,
              ctx: !!this.ctx
            });
            return;
          }
          
          // ç»˜åˆ¶å¯æ”¶é›†çš„éŸ³ä¹é£æ ¼å›¾æ ‡
          this.collectibles.forEach(collectible => {
            // åªç»˜åˆ¶æœªæ”¶é›†å’Œæœªé¿å¼€çš„æ”¶é›†ç‰©
            if (!collectible.collected && !collectible.avoided) {
              // ç»˜åˆ¶å›¾æ ‡èƒŒæ™¯
              this.ctx.fillStyle = collectible.genre.color;
              this.ctx.beginPath();
              this.ctx.arc(
                collectible.x + collectible.width/2,
                collectible.y + collectible.height/2,
                collectible.width/2,
                0,
                Math.PI * 2
              );
              this.ctx.fill();
              
              // æ·»åŠ è¾¹æ¡†ï¼Œä½¿å…¶æ›´å®¹æ˜“çœ‹è§
              this.ctx.strokeStyle = 'white';
              this.ctx.lineWidth = 2;
              this.ctx.stroke();
              
              // ç»˜åˆ¶å›¾æ ‡
              this.ctx.fillStyle = '#FFF';
              this.ctx.font = '20px Arial';
              this.ctx.textAlign = 'center';
              this.ctx.textBaseline = 'middle';
              this.ctx.fillText(
                collectible.genre.icon,
                collectible.x + collectible.width/2,
                collectible.y + collectible.height/2
              );
              
              // ç»˜åˆ¶éŸ³ä¹é£æ ¼åç§°
              this.ctx.fillStyle = '#FFF';
              this.ctx.font = 'bold 14px Arial';
              this.ctx.textAlign = 'center';
              
              // æ·»åŠ åç§°èƒŒæ™¯ä»¥æé«˜å¯è¯»ï¿½?
              const textWidth = this.ctx.measureText(collectible.genre.name).width;
              this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
              this.ctx.fillRect(
                collectible.x + collectible.width/2 - textWidth/2 - 5,
                collectible.y + collectible.height + 10,
                textWidth + 10,
                20
              );
              
              // é‡æ–°ç»˜åˆ¶æ–‡å­—ä½¿å…¶åœ¨èƒŒæ™¯ä¸Šï¿?
              this.ctx.fillStyle = '#FFF';
              this.ctx.fillText(
                collectible.genre.name,
                collectible.x + collectible.width/2,
                collectible.y + collectible.height + 20
              );
            }
          });
          
          // æ·»åŠ æ—¥å¿—ï¼Œæ˜¾ç¤ºæ”¶é›†ç‰©æ•°é‡
          if (this.collectibles.length > 0) {
            const activeCount = this.collectibles.filter(c => !c.collected && !c.avoided).length;
            if (activeCount === 0) {
              // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æ”¶é›†ç‰©ï¼Œç”Ÿæˆæ›´ï¿?
              console.log('æ²¡æœ‰æ´»åŠ¨çš„æ”¶é›†ç‰©ï¼Œç”Ÿæˆæ›´ï¿?);
              this.generateMoreCollectibles(5);
            }
          }
        } catch (error) {
          console.error('ç»˜åˆ¶æ”¶é›†ç‰©æ—¶å‡ºé”™:', error);
        }
      },
      
      drawScore() {
        // ç»˜åˆ¶å¾—åˆ†
        this.ctx.fillStyle = '#FFF';
        this.ctx.font = '16px Arial';
        this.ctx.textAlign = 'left';
        this.ctx.fillText(`å¾—åˆ†: ${this.score}`, 10, 20);
        this.ctx.fillText(`å·²æ”¶ï¿? ${this.preferences.length}/${this.genres.length}`, 10, 40);
      },
      
      showFinishScreen() {
        this.gameRunning = false;
        
        // æ¸…ç©ºç”»å¸ƒ
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // ç»˜åˆ¶èƒŒæ™¯
        this.ctx.fillStyle = '#191919';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // åˆ›å»ºæ›´å¤šåº†ç¥ç²’å­æ•ˆæœ
        const celebrationParticles = [];
        for (let i = 0; i < 100; i++) {
          celebrationParticles.push({
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            radius: Math.random() * 4 + 1,
            color: `rgba(155, 75, 255, ${Math.random() * 0.7 + 0.3})`,
            speedX: (Math.random() - 0.5) * 3,
            speedY: (Math.random() - 0.5) * 3
          });
        }
        
        // ç»˜åˆ¶ç´«è‰²æ ‡é¢˜
        this.ctx.fillStyle = '#9B4BFF';
        this.ctx.font = '32px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(
          'æ­å–œå®Œæˆæ”¶é›†!',
          this.canvas.width / 2,
          this.canvas.height / 2 - 50
        );
        
        // ç»˜åˆ¶å®Œæˆä¿¡æ¯
        this.ctx.fillStyle = '#FFF';
        this.ctx.font = '24px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(
          'æ”¶é›†å®Œæˆ! ç‚¹å‡»ä¸‹æ–¹"å®Œæˆ"æŒ‰é’®ä¿å­˜æ‚¨çš„éŸ³ä¹åå¥½!',
          this.canvas.width / 2,
          this.canvas.height / 2
        );
        
        // æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
        const finishButton = document.getElementById('game-finish');
        if (finishButton) {
          finishButton.classList.remove('is-hidden');
        }
        
        // é‡ç½®å¼€å§‹æŒ‰ï¿?
        const startButton = document.getElementById('game-start');
        if (startButton) {
          startButton.disabled = false;
        }
        
        // æŒç»­æ›´æ–°åº†ç¥ç²’å­æ•ˆæœ
        const updateCelebration = () => {
          if (!this.gameRunning) {
            // æ¸…ç©ºç”»å¸ƒ
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.fillStyle = '#191919';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
            // æ›´æ–°å¹¶ç»˜åˆ¶ç²’ï¿?
            celebrationParticles.forEach(particle => {
              particle.x += particle.speedX;
              particle.y += particle.speedY;
              
              // å¦‚æœç²’å­è¶…å‡ºè¾¹ç•Œï¼Œå°†å…¶ç§»åŠ¨åˆ°å¦ä¸€ï¿?
              if (particle.x < 0) particle.x = this.canvas.width;
              if (particle.x > this.canvas.width) particle.x = 0;
              if (particle.y < 0) particle.y = this.canvas.height;
              if (particle.y > this.canvas.height) particle.y = 0;
              
              // ç»˜åˆ¶ç²’å­
              this.ctx.beginPath();
              this.ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
              this.ctx.fillStyle = particle.color;
              this.ctx.fill();
            });
            
            // é‡æ–°ç»˜åˆ¶æ–‡å­—
            this.ctx.fillStyle = '#9B4BFF';
            this.ctx.font = '32px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(
              'æ­å–œå®Œæˆæ”¶é›†!',
              this.canvas.width / 2,
              this.canvas.height / 2 - 50
            );
            
            this.ctx.fillStyle = '#FFF';
            this.ctx.font = '24px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(
              'æ”¶é›†å®Œæˆ! ç‚¹å‡»ä¸‹æ–¹"å®Œæˆ"æŒ‰é’®ä¿å­˜æ‚¨çš„éŸ³ä¹åå¥½!',
              this.canvas.width / 2,
              this.canvas.height / 2
            );
            
            requestAnimationFrame(updateCelebration);
          }
        };
        
        // å¯åŠ¨åº†ç¥åŠ¨ç”»
        updateCelebration();
        
        console.log('æ¸¸æˆå®Œæˆï¼Œæ˜¾ç¤ºç»“æŸç•Œï¿?);
      },
      
      finishGame() {
        console.log('å®Œæˆæ¸¸æˆï¼Œä¿å­˜åï¿?);
        // è·å–ç”¨æˆ·åœ¨æ¸¸æˆä¸­æ”¶é›†çš„éŸ³ä¹åï¿?
        const preferences = this.preferences.map(p => p.id);
        
        // è°ƒç”¨Vueåº”ç”¨ä¸­çš„æ–¹æ³•ä¿å­˜åå¥½
        if (window.app) {
          console.log('æ­£åœ¨ä¿å­˜æ¸¸æˆæ”¶é›†çš„éŸ³ä¹åï¿?', preferences);
          window.app.saveGamePreferences(preferences);
        } else {
          console.error('æ— æ³•è®¿é—®Vueåº”ç”¨å®ä¾‹ï¼Œæ— æ³•ä¿å­˜éŸ³ä¹åï¿?);
        }
        
        // éšè—å®ŒæˆæŒ‰é’®
        const finishButton = document.getElementById('game-finish');
        if (finishButton) {
          finishButton.classList.add('is-hidden');
        }
      },
      
      // æ·»åŠ æµ‹è¯•åŠŸèƒ½å’Œè¯Šæ–­ä¿¡ï¿?
      diagnoseGameState() {
        console.log('==================');
        console.log('æ¸¸æˆè¯Šæ–­ä¿¡æ¯:');
        console.log('Canvas:', !!this.canvas);
        console.log('ä¸Šä¸‹ï¿?', !!this.ctx);
        console.log('ç©å®¶:', !!this.player);
        if (this.player) {
          console.log('ç©å®¶ä½ç½®:', this.player.x, this.player.y);
        }
        console.log('æ¸¸æˆè¿è¡ŒçŠ¶ï¿½?', this.gameRunning);
        console.log('æ¸¸æˆæš‚åœçŠ¶ï¿½?', this.gamePaused);
        console.log('æ”¶é›†ç‰©æ•°ï¿?', this.collectibles ? this.collectibles.length : 0);
        console.log('æ´»åŠ¨æ”¶é›†ï¿?', this.collectibles ? this.collectibles.filter(c => !c.collected && !c.avoided).length : 0);
        console.log('é”®ç›˜äº‹ä»¶ç»‘å®š:', !!this._keydownHandler);
        console.log('æ¸¸æˆå¾ªç¯ID:', !!this._gameLoopId);
        console.log('==================');
        
        // å°è¯•ä¿®å¤å¸¸è§é—®é¢˜
        if (!this.gameRunning && this.player) {
          console.log('æ¸¸æˆæœªè¿è¡Œï¼Œå°è¯•é‡æ–°å¯åŠ¨');
          this.gameRunning = true;
          this.gamePaused = false;
          this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
        }
        
        if (this.gameRunning && (!this.collectibles || this.collectibles.length === 0)) {
          console.log('æ²¡æœ‰æ”¶é›†ç‰©ï¼Œå°è¯•ç”Ÿæˆ');
          this.generateCollectibles();
        }
        
        if (!this._keydownHandler) {
          console.log('é”®ç›˜äº‹ä»¶æœªç»‘å®šï¼Œå°è¯•é‡æ–°ç»‘å®š');
          this.setupEventListeners();
        }
        
        // å¼ºåˆ¶é‡ç»˜ä¸€ï¿?
        if (this.canvas && this.ctx) {
          this.gameLoop();
          console.log('å¼ºåˆ¶é‡ç»˜å®Œæˆ');
        }
      }
    }
  });
  
  // å°†äº‹ä»¶æ€»çº¿æš´éœ²ç»™å…¨å±€ï¼Œä»¥ä¾¿ç»„ä»¶é—´é€šä¿¡
  window.EventBus = EventBus;
  
  // æ·»åŠ Vueå…¨å±€é”™è¯¯å¤„ç†
  Vue.config.errorHandler = function(err, vm, info) {
    console.error('Vueé”™è¯¯:', err);
    console.error('ç»„ä»¶:', vm);
    console.error('ä¿¡æ¯:', info);
  };
}); 

// éŸ³ä¹åå¥½æ¸¸æˆå¯¹è±¡
const musicGame = {
  // æ¸¸æˆå…¨å±€å±æ€§ï¼Œç¡®ä¿è¿™äº›å˜é‡ä¸ä¼šè¢«é‡ï¿?
  canvas: null,
  ctx: null,
  player: null,
  preferences: [],
  genres: [
    { id: 'pop', name: 'æµè¡Œ', icon: 'ğŸµ', color: '#ff5252' },
    { id: 'rock', name: 'æ‘‡æ»š', icon: 'ğŸ¸', color: '#ff9800' },
    { id: 'classical', name: 'å¤å…¸', icon: 'ğŸ»', color: '#9c27b0' },
    { id: 'electronic', name: 'ç”µå­', icon: 'ğŸ§', color: '#2196f3' },
    { id: 'jazz', name: 'çˆµå£«', icon: 'ğŸ·', color: '#4caf50' },
    { id: 'hiphop', name: 'å˜»å“ˆ', icon: 'ğŸ¤', color: '#795548' },
    { id: 'folk', name: 'æ°‘è°£', icon: 'ğŸª•', color: '#607d8b' },
    { id: 'rb', name: 'R&B', icon: 'ğŸ¹', color: '#e91e63' }
  ],
  collectibles: [],
  gameRunning: false,
  score: 0,
  gravity: 0.5,
  ground: 0,
  particles: [],
  _initialized: false,
  _eventListenersSet: false,
  _gameLoopId: null,
  
  init() {
    try {
      console.log('æ­£åœ¨åˆå§‹åŒ–éŸ³ä¹æ¸¸ï¿?..');
      
      // è·å–canvaså…ƒç´ 
      this.canvas = document.getElementById('game-canvas');
      if (!this.canvas) {
        console.error('æ‰¾ä¸åˆ°æ¸¸æˆç”»å¸ƒå…ƒï¿?');
        
        // å°è¯•åˆ›å»ºcanvas
        const container = document.querySelector('.game-container');
        if (container) {
          console.log('å°è¯•åˆ›å»ºcanvaså…ƒç´ ...');
          this.canvas = document.createElement('canvas');
          this.canvas.id = 'game-canvas';
          this.canvas.width = container.clientWidth;
          this.canvas.height = 400;
          container.appendChild(this.canvas);
          console.log('å·²åˆ›å»ºcanvaså…ƒç´ :', this.canvas);
        } else {
          console.error('æ‰¾ä¸åˆ°game-containerï¼Œæ— æ³•åˆ›å»ºcanvas');
          return false;
        }
      }
      
      // è·å–2Dä¸Šä¸‹ï¿?
      this.ctx = this.canvas.getContext('2d');
      if (!this.ctx) {
        console.error('æ— æ³•è·å–canvas 2Dä¸Šä¸‹ï¿?);
        return false;
      }
      
      console.log('Canvaså‡†å¤‡å°±ç»ª:', this.canvas.width, 'x', this.canvas.height);
      
      // åˆå§‹åŒ–æ¸¸æˆå˜ï¿?
      this.gravity = 0.5;
      this.score = 0;
      this.preferences = [];
      this.collectibles = [];
      this.particles = [];
      this.gameRunning = false;
      this.gamePaused = false;
      this.gameCompleted = false;
      
      // å®šä¹‰éŸ³ä¹é£æ ¼
      this.genres = [
        { name: 'æµè¡ŒéŸ³ä¹', icon: 'ğŸµ', color: '#FF5733' },
        { name: 'æ‘‡æ»š', icon: 'ğŸ¤˜', color: '#C70039' },
        { name: 'å¤å…¸', icon: 'ğŸ»', color: '#900C3F' },
        { name: 'çˆµå£«', icon: 'ğŸ·', color: '#581845' },
        { name: 'ç”µå­', icon: 'ğŸ§', color: '#FFC300' },
        { name: 'å˜»å“ˆ', icon: 'ğŸ¤', color: '#DAF7A6' },
        { name: 'æ°‘è°£', icon: 'ğŸª•', color: '#FF5733' },
        { name: 'è“è°ƒ', icon: 'ğŸ¸', color: '#C70039' }
      ];
      
      // åˆ›å»ºç©å®¶å¯¹è±¡
      this.player = {
        x: 100,
        y: 300,
        width: 40,
        height: 40,
        speed: 5,
        dy: 0,
        jumping: false,
        grounded: true
      };
      
      // è®¡ç®—åœ°é¢é«˜åº¦
      this.ground = this.canvas.height - this.player.height;
      
      // è®¾ç½®äº‹ä»¶ç›‘å¬ï¿?
      this.setupEventListeners();
      
      // ç»˜åˆ¶åˆå§‹å±å¹•
      this.drawInitialScreen();
      
      console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œåœ°é¢ä½ç½®:', this.ground);
      return true;
      
    } catch (error) {
      console.error('åˆå§‹åŒ–æ¸¸æˆæ—¶å‡ºé”™:', error);
      return false;
    }
  },
  
  // å¼€å§‹æ¸¸ï¿?
  startGame() {
    try {
      console.log('===== å¼€å§‹æ¸¸ï¿?=====');
      
      // 1. ç¡®è®¤canvaså’Œctxå·²åˆå§‹åŒ–
      if (!this.canvas || !this.ctx) {
        console.log('Canvasæœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–...');
        if (!this.init()) {
          alert('æ— æ³•åˆå§‹åŒ–æ¸¸æˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡ï¿?);
          return;
        }
      }
      
      console.log('CanvasçŠ¶ï¿½?', this.canvas.width, 'x', this.canvas.height);
      
      // 2. é‡ç½®æ¸¸æˆçŠ¶ï¿½?
      this.gameRunning = true;
      this.gamePaused = false;
      this.gameCompleted = false;
      this.score = 0;
      
      // 3. é‡ç½®ç©å®¶ä½ç½®
      this.player = {
        x: 100,
        y: 300,
        width: 40,
        height: 40,
        speed: 5,
        dy: 0,
        jumping: false,
        grounded: true
      };
      
      this.ground = this.canvas.height - this.player.height;
      console.log('ç©å®¶å·²é‡ï¿?', this.player);
      
      // 4. æ¸…ç©ºå¹¶é‡æ–°ç”Ÿæˆæ”¶é›†ç‰©
      this.collectibles = [];
      this.generateCollectibles();
      console.log('æ”¶é›†ç‰©å·²ç”Ÿæˆ:', this.collectibles.length);
      
      // 5. æ¸…ç©ºç²’å­æ•ˆæœ
      this.particles = [];
      
      // 6. å°è¯•è¿›å…¥å…¨å±
      this.toggleFullscreen();
      
      // 7. ç«‹å³ç»˜åˆ¶ä¸€å¸§æ¸¸æˆç”»é¢ï¼Œé¿å…é»‘å±
      this.gameLoop();
      console.log('ç¬¬ä¸€å¸§æ¸¸æˆå·²ç»˜åˆ¶');
      
      // 8. éšè—/æ˜¾ç¤ºç›¸å…³æŒ‰é’®
      const startButton = document.getElementById('game-start');
      if (startButton) {
        startButton.disabled = true;
      }
      
      const finishButton = document.getElementById('game-finish');
      if (finishButton) {
        finishButton.classList.add('is-hidden');
      }
      
      // 9. è°ƒè¯•è¾“å‡º
      console.log('æ¸¸æˆæˆåŠŸå¯åŠ¨! è¯·ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶:');
      console.log('- å·¦å³ç®­å¤´: ç§»åŠ¨è§’è‰²');
      console.log('- ä¸Šç®­ï¿? è·³è·ƒ');
      console.log('- ç©ºæ ¼ï¿? æš‚åœ/ç»§ç»­');
      console.log('===================');
      
    } catch (error) {
      console.error('å¯åŠ¨æ¸¸æˆæ—¶å‡ºï¿?', error);
      alert('å¯åŠ¨æ¸¸æˆæ—¶å‡ºé”™ï¼Œè¯·å°è¯•åˆ·æ–°é¡µï¿?);
    }
  },
  
  // æ¸¸æˆå¾ªç¯
  gameLoop() {
    try {
      // ç¡®ä¿å¿…è¦çš„å¯¹è±¡å­˜ï¿?
      if (!this.canvas || !this.ctx || !this.player) {
        console.error('gameLoop: ç¼ºå°‘å¿…è¦å¯¹è±¡', {
          canvas: !!this.canvas,
          ctx: !!this.ctx,
          player: !!this.player
        });
        return;
      }
      
      // æ¸…é™¤ç”»å¸ƒ
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      
      // ç»˜åˆ¶èƒŒæ™¯
      this.ctx.fillStyle = '#191919';
      this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
      
      // ç»˜åˆ¶åœ°é¢
      this.ctx.fillStyle = '#333';
      this.ctx.fillRect(0, this.ground + this.player.height, this.canvas.width, 5);
      
      // å¦‚æœæ¸¸æˆå·²æš‚åœï¼Œæ˜¾ç¤ºæš‚åœå±å¹•
      if (this.gamePaused) {
        this.drawPauseScreen();
        return;
      }
      
      // å¦‚æœæ¸¸æˆå·²å®Œæˆï¼Œæ˜¾ç¤ºå®Œæˆå±å¹•
      if (this.gameCompleted) {
        this.showFinishScreen();
        return;
      }
      
      // æ›´æ–°ç©å®¶
      this.updatePlayer();
      
      // æ›´æ–°æ”¶é›†ç‰©ä½ï¿?
      this.updateCollectibles();
      
      // æ£€æŸ¥ç¢°ï¿?
      this.checkCollisions();
      
      // æ›´æ–°ç²’å­æ•ˆæœ
      if (typeof this.updateParticles === 'function') {
        this.updateParticles();
      }
      
      // ç»˜åˆ¶ç©å®¶
      this.drawPlayer();
      
      // ç»˜åˆ¶æ”¶é›†ï¿?
      this.drawCollectibles();
      
      // ç»˜åˆ¶ç²’å­æ•ˆæœ
      if (typeof this.drawParticles === 'function') {
        this.drawParticles();
      }
      
      // ç»˜åˆ¶åˆ†æ•°
      this.drawScore();
      
      // ç»˜åˆ¶åå¥½æ˜¾ç¤º
      if (typeof this.drawPreferences === 'function') {
        this.drawPreferences();
      }
      
      // ç»§ç»­æ¸¸æˆå¾ªç¯
      if (this.gameRunning) {
        this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
      }
    } catch (error) {
      console.error('æ¸¸æˆå¾ªç¯ä¸­å‡ºï¿?', error);
      
      // å°è¯•æ¢å¤æ¸¸æˆè¿è¡Œ
      if (this.gameRunning) {
        this._gameLoopId = requestAnimationFrame(() => this.gameLoop());
      }
    }
  },
  
  // åˆ›å»ºç²’å­æ•ˆæœ
  createParticles() {
    // æ¸…ç©ºç°æœ‰ç²’å­
    this.particles = [];
    
    // åˆ›å»ºæ–°ç²’ï¿?
    for (let i = 0; i < 50; i++) {
      this.particles.push({
        x: Math.random() * this.canvas.width,
        y: Math.random() * this.canvas.height,
        radius: Math.random() * 3 + 1,
        color: `rgba(155, 75, 255, ${Math.random() * 0.5 + 0.1})`,
        speedX: Math.random() * 0.5 - 0.25,
        speedY: Math.random() * 0.5 - 0.25
      });
    }
  },
  
  // æ›´æ–°ç²’å­
  updateParticles() {
    if (!this.particles || !Array.isArray(this.particles)) return;
    
    for (let i = 0; i < this.particles.length; i++) {
      let p = this.particles[i];
      
      // æ›´æ–°ç²’å­ä½ç½®
      p.x += p.speedX;
      p.y += p.speedY;
      
      // è¾¹ç•Œæ£€æŸ?
      if (p.x < 0 || p.x > this.canvas.width) {
        p.speedX *= -1;
      }
      
      if (p.y < 0 || p.y > this.canvas.height) {
        p.speedY *= -1;
      }
    }
  },
  
  // å½“Vueåº”ç”¨åŠ è½½å®Œæˆï¿?æˆ–ä¸€æ®µæ—¶é—´å)åˆå§‹åŒ–æ¸¸ï¿?
  setTimeout(() => {
    initGameWhenCanvasReady();
  }, 1000);
}; 

// åœ¨document.addEventListener('DOMContentLoaded')åæ·»åŠ æ¸²æŸ“ä¿®å¤å‡½ï¿?

// æ·»åŠ ä¿®å¤Vue.jsæ¨¡æ¿æ¸²æŸ“é—®é¢˜çš„å‡½ï¿?
function fixTemplateRendering() {
  console.log('æ­£åœ¨ä¿®å¤æ¨¡æ¿æ¸²æŸ“é—®é¢˜...');
  
  // æ£€æŸ¥Vueå®ä¾‹æ˜¯å¦å·²æ­£ç¡®åˆå§‹åŒ–
  if (!window.app) {
    console.error('Vueå®ä¾‹æœªæ‰¾åˆ°ï¼Œå°è¯•é‡æ–°åˆå§‹ï¿?);
    
    // ç¡®ä¿translationså¯¹è±¡å­˜åœ¨ï¼Œç”¨äºæ¨¡æ¿æ¸²ï¿?
    const translations = {
      zh: {
        'username': 'ç”¨æˆ·ï¿?,
        'email': 'é‚®ç®±',
        'password': 'å¯†ç ',
        'login': 'ç™»å½•',
        'register': 'æ³¨å†Œ',
        'logout': 'é€€ï¿?,
        'developer': 'å¼€å‘ï¿½?,
        'registerPrompt': 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ',
        'loginPrompt': 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»ï¿?,
        'welcome': 'æ¬¢è¿',
        'survey': 'é—®å·',
        'recommendations': 'æ¨è',
        'chat': 'èŠå¤©',
        'evaluation': 'è¯„ä»·',
        'musicPreference': 'éŸ³ä¹åå¥½',
        'submit': 'æäº¤',
        'next': 'ä¸‹ä¸€ï¿?,
        'previous': 'ä¸Šä¸€ï¿?,
        'searchPlaceholder': 'æœç´¢éŸ³ä¹...',
        'songName': 'æ­Œæ›²ï¿?,
        'artist': 'è‰ºæœ¯ï¿?,
        'rating': 'è¯„åˆ†'
      },
      en: {
        'username': 'Username',
        'email': 'Email',
        'password': 'Password',
        'login': 'Login',
        'register': 'Register',
        'logout': 'Logout',
        'developer': 'Developer',
        'registerPrompt': 'No account? Register here',
        'loginPrompt': 'Already have an account? Login here',
        'welcome': 'Welcome',
        'survey': 'Survey',
        'recommendations': 'Recommendations',
        'chat': 'Chat',
        'evaluation': 'Evaluation',
        'musicPreference': 'Music Preference',
        'submit': 'Submit',
        'next': 'Next',
        'previous': 'Previous',
        'searchPlaceholder': 'Search music...',
        'songName': 'Song Name',
        'artist': 'Artist',
        'rating': 'Rating'
      }
    };
    
    // é‡æ–°åˆå§‹åŒ–Vueåº”ç”¨
    try {
      window.app = new Vue({
        el: '#app',
        data: {
          currentTab: 'welcome',
          username: '',
          email: '',
          password: '',
          currentLanguage: 'zh',
          isLoggedIn: false,
          currentUser: null,
          loginError: '',
          registerError: '',
          translations: translations,
          notifications: []
        },
        methods: {
          t(key) {
            if (!key) return '';
            try {
              const translation = this.translations[this.currentLanguage][key];
              return translation || key;
            } catch (e) {
              console.error('ç¿»è¯‘é”™è¯¯:', e);
              return key;
            }
          },
          switchLanguage(lang) {
            console.log('åˆ‡æ¢è¯­è¨€ï¿?', lang);
            this.currentLanguage = lang;
            localStorage.setItem('language', lang);
          },
          login() {
            console.log('å°è¯•ç™»å½•...');
            // ç™»å½•é€»è¾‘
          },
          logout() {
            console.log('ç™»å‡º...');
            this.isLoggedIn = false;
            this.currentUser = null;
          },
          register() {
            console.log('å°è¯•æ³¨å†Œ...');
            // æ³¨å†Œé€»è¾‘
          }
        },
        mounted() {
          // å¼ºåˆ¶ç«‹å³æ›´æ–°æ‰€æœ‰ç»‘å®šï¼Œç¡®ä¿æ¨¡æ¿æ¸²æŸ“
          this.$nextTick(() => {
            this.$forceUpdate();
            console.log('å¼ºåˆ¶æ›´æ–°Vueå®ä¾‹å®Œæˆ');
          });
        }
      });
      
      console.log('Vueå®ä¾‹å·²é‡æ–°åˆå§‹åŒ–');
    } catch (e) {
      console.error('é‡æ–°åˆå§‹åŒ–Vueå®ä¾‹å¤±è´¥:', e);
    }
  } else {
    // å¼ºåˆ¶Vueå®ä¾‹æ›´æ–°
    try {
      window.app.$forceUpdate();
      console.log('å¼ºåˆ¶åˆ·æ–°Vueå®ä¾‹');
    } catch (e) {
      console.error('å¼ºåˆ¶åˆ·æ–°Vueå®ä¾‹å¤±è´¥:', e);
    }
  }
  
  // æ‰‹åŠ¨æ›¿æ¢æ‰€æœ‰æœªæ¸²æŸ“çš„æ¨¡æ¿è¯­ï¿?
  setTimeout(() => {
    console.log('æ£€æŸ¥æœªæ¸²æŸ“çš„æ¨¡æ¿æ ‡ï¿?..');
    
    // è·å–æ‰€æœ‰å¯èƒ½åŒ…å«æœªæ¸²æŸ“æ¨¡æ¿çš„å…ƒï¿?
    const elements = document.querySelectorAll('*:not(script):not(style)');
    
    // è®¡æ•°ä¿®å¤çš„æ¨¡æ¿è¡¨è¾¾å¼
    let fixCount = 0;
    
    elements.forEach(el => {
      // æ£€æŸ¥å…ƒç´ çš„textContentå’ŒinnerHTML
      if (el.innerHTML && el.innerHTML.includes('{{') && el.innerHTML.includes('}}')) {
        const originalHTML = el.innerHTML;
        
        // æ›¿æ¢ {{ t('key') }} æ ¼å¼çš„æ¨¡ï¿?
        let newHTML = originalHTML.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, (match, key) => {
          fixCount++;
          
          // è·å–ç¿»è¯‘æ–‡æœ¬
          let replacement = key;
          if (window.app && window.app.translations && 
              window.app.translations[window.app.currentLanguage] && 
              window.app.translations[window.app.currentLanguage][key]) {
            replacement = window.app.translations[window.app.currentLanguage][key];
          }
          
          return replacement;
        });
        
        // å¦‚æœå‘ç”Ÿäº†æ›¿æ¢ï¼Œæ›´æ–°HTML
        if (newHTML !== originalHTML) {
          el.innerHTML = newHTML;
        }
      }
      
      // æ£€æŸ¥å…ƒç´ çš„å­æ–‡æœ¬èŠ‚ï¿?
      if (el.childNodes && el.childNodes.length > 0) {
        el.childNodes.forEach(node => {
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨¡æ¿è¯­ï¿?{{ ... }}
            if (text.includes('{{') && text.includes('}}')) {
              
              // æ›¿æ¢æ‰€æœ‰æ¨¡æ¿è¡¨è¾¾å¼
              let newText = text.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, (match, key) => {
                fixCount++;
                
                // è·å–ç¿»è¯‘æ–‡æœ¬
                let replacement = key;
                if (window.app && window.app.translations && 
                    window.app.translations[window.app.currentLanguage] && 
                    window.app.translations[window.app.currentLanguage][key]) {
                  replacement = window.app.translations[window.app.currentLanguage][key];
                }
                
                return replacement;
              });
              
              // å¦‚æœå‘ç”Ÿäº†æ›¿æ¢ï¼Œæ›´æ–°æ–‡æœ¬
              if (newText !== text) {
                node.textContent = newText;
              }
            }
          }
        });
      }
    });
    
    console.log(`ä¿®å¤ï¿?${fixCount} ä¸ªæ¨¡æ¿è¡¨è¾¾å¼`);
    
    // æ£€æŸ¥æ˜¯å¦ä»æœ‰æœªæ¸²æŸ“çš„æ¨¡ï¿?
    const stillHasUnrenderedTemplates = document.body.innerHTML.includes('{{') && 
                                      document.body.innerHTML.includes('}}');
    
    if (stillHasUnrenderedTemplates) {
      console.log('ä»æœ‰æœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œå°è¯•é‡æ–°ä¿®ï¿?);
      setTimeout(fixTemplateRendering, 500);
    }
  }, 100);
}

// ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åè°ƒç”¨ä¿®å¤å‡½ï¿?
window.addEventListener('load', function() {
  console.log('é¡µé¢å®Œå…¨åŠ è½½ï¼Œæ£€æŸ¥æ¨¡æ¿æ¸²æŸ“çŠ¶ï¿?);
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¸²æŸ“çš„æ¨¡æ¿æ ‡è®°
  setTimeout(() => {
    const hasUnrenderedTemplates = document.body.innerHTML.includes('{{') && 
                                  document.body.innerHTML.includes('}}');
    
    if (hasUnrenderedTemplates) {
      console.log('æ£€æµ‹åˆ°æœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œå°è¯•ä¿®ï¿?);
      fixTemplateRendering();
    } else {
      console.log('æ¨¡æ¿æ¸²æŸ“æ­£å¸¸');
    }
  }, 500); // å»¶è¿Ÿæ£€æŸ¥ä»¥ç¡®ä¿Vueæœ‰æ—¶é—´æ¸²ï¿?
});

// ç›‘å¬DOMå˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°æ·»åŠ çš„æœªæ¸²æŸ“æ¨¡ï¿?
document.addEventListener('DOMContentLoaded', function() {
  // åˆ›å»ºMutationObserverè§‚å¯ŸDOMå˜åŒ–
  const observer = new MutationObserver((mutations) => {
    let needsFix = false;
    
    // æ£€æŸ¥å˜åŒ–çš„èŠ‚ç‚¹
    mutations.forEach(mutation => {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        // æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ¸¸æˆç”»å¸ƒå…ƒç´ 
        if (checkAndInitCanvas()) {
          console.log('é€šè¿‡MutationObserveræ£€æµ‹åˆ°canvaså¹¶åˆå§‹åŒ–æ¸¸æˆ');
          tabObserver.disconnect();
          return;
        }
      }
    });
  });
  
  // ç›‘å¬æ•´ä¸ªæ–‡æ¡£çš„å˜ï¿?
  tabObserver.observe(document.body, { 
    childList: true, 
    subtree: true 
  });
  
  // å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨é—´éš”è½®è¯¢æ£€æŸ¥canvasæ˜¯å¦å·²åŠ ï¿?
  let attempts = 0;
  const maxAttempts = 10;
  
  const canvasCheckInterval = setInterval(() => {
    attempts++;
    console.log(`æ£€æŸ¥æ¸¸æˆç”»ï¿?- å°è¯• ${attempts}/${maxAttempts}`);
    
    if (checkAndInitCanvas()) {
      console.log('é€šè¿‡è½®è¯¢æ£€æµ‹åˆ°canvaså¹¶åˆå§‹åŒ–æ¸¸æˆ');
      clearInterval(canvasCheckInterval);
      return;
    }
    
    if (attempts >= maxAttempts) {
      console.error('å¤šæ¬¡å°è¯•åä»æ‰¾ä¸åˆ°æ¸¸æˆç”»å¸ƒå…ƒï¿?');
      clearInterval(canvasCheckInterval);
      
      // å°è¯•å¼ºåˆ¶æ·»åŠ canvaså…ƒç´ 
      const gameScreen = document.querySelector('.game-screen');
      if (gameScreen) {
        console.log('å°è¯•å¼ºåˆ¶åˆ›å»ºcanvaså…ƒç´ ...');
        const canvas = document.createElement('canvas');
        canvas.id = 'game-canvas';
        canvas.width = 800;
        canvas.height = 400;
        gameScreen.innerHTML = '';
        gameScreen.appendChild(canvas);
        
        setTimeout(() => {
          checkAndInitCanvas();
        }, 100);
      }
    }
  }, 1000);
}); 

/**
 * ä¿®å¤æ¨¡æ¿æ¸²æŸ“é—®é¢˜
 * æ£€æŸ¥é¡µé¢ä¸Šæœªæ¸²æŸ“çš„æ¨¡æ¿è¡¨è¾¾å¼å¹¶æ›¿æ¢ä¸ºæ­£ç¡®çš„æ–‡æœ¬
 */
const fixTemplateRendering = function() {
  console.log('æ­£åœ¨æ£€æŸ¥å’Œä¿®å¤æœªæ¸²æŸ“çš„æ¨¡æ¿...');
  
  // æ£€æŸ¥Vueå®ä¾‹æ˜¯å¦å­˜åœ¨
  if (!window.app) {
    console.error('Vueå®ä¾‹ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿®å¤æ¨¡æ¿');
    return;
  }
  
  // å®šä¹‰ç¿»è¯‘å¯¹è±¡
  if (!window.app.translations) {
    window.app.translations = {
      zh: {
        'username': 'ç”¨æˆ·ï¿?,
        'email': 'é‚®ç®±',
        'password': 'å¯†ç ',
        'login': 'ç™»å½•',
        'register': 'æ³¨å†Œ',
        'logout': 'é€€ï¿?,
        'developer': 'å¼€å‘ï¿½?,
        'registerPrompt': 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ',
        'loginPrompt': 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»ï¿?,
        'welcome': 'æ¬¢è¿',
        'survey': 'é—®å·',
        'recommendations': 'æ¨è',
        'chat': 'èŠå¤©',
        'evaluation': 'è¯„ä»·',
        'musicPreference': 'éŸ³ä¹åå¥½',
        'submit': 'æäº¤',
        'next': 'ä¸‹ä¸€ï¿?,
        'previous': 'ä¸Šä¸€ï¿?,
        'searchPlaceholder': 'æœç´¢éŸ³ä¹...',
        'songName': 'æ­Œæ›²ï¿?,
        'artist': 'è‰ºæœ¯ï¿?,
        'rating': 'è¯„åˆ†'
      },
      en: {
        'username': 'Username',
        'email': 'Email',
        'password': 'Password',
        'login': 'Login',
        'register': 'Register',
        'logout': 'Logout',
        'developer': 'Developer',
        'registerPrompt': 'No account? Click to register',
        'loginPrompt': 'Already have an account? Click to login',
        'welcome': 'Welcome',
        'survey': 'Survey',
        'recommendations': 'Recommendations',
        'chat': 'Chat',
        'evaluation': 'Evaluation',
        'musicPreference': 'Music Preference',
        'submit': 'Submit',
        'next': 'Next',
        'previous': 'Previous',
        'searchPlaceholder': 'Search music...',
        'songName': 'Song Name',
        'artist': 'Artist',
        'rating': 'Rating'
      }
    };
  }
  
  // è®¾ç½®å½“å‰è¯­è¨€
  if (!window.app.currentLanguage) {
    window.app.currentLanguage = 'zh';
  }
  
  let fixCount = 0;
  
  // æŸ¥æ‰¾æ‰€æœ‰æ–‡æœ¬èŠ‚ï¿?
  const textNodes = [];
  function findTextNodes(node) {
    if (node.nodeType === Node.TEXT_NODE) {
      textNodes.push(node);
    } else {
      for (let i = 0; i < node.childNodes.length; i++) {
        findTextNodes(node.childNodes[i]);
      }
    }
  }
  
  // ä»æ–‡æ¡£ä½“å¼€å§‹æŸ¥ï¿?
  findTextNodes(document.body);
  
  // æ£€æŸ¥æ¯ä¸ªæ–‡æœ¬èŠ‚ï¿?
  textNodes.forEach(node => {
    const text = node.textContent;
    
    // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«æ¨¡æ¿è¯­ï¿?
    if (text.includes('{{') && text.includes('}}')) {
      // æ›¿æ¢æ‰€æœ‰æ¨¡æ¿è¡¨è¾¾å¼
      const newText = text.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, function(match, key) {
        fixCount++;
        
        // è·å–ç¿»è¯‘æ–‡æœ¬
        let replacement = key;
        if (window.app.translations && 
            window.app.translations[window.app.currentLanguage] && 
            window.app.translations[window.app.currentLanguage][key]) {
          replacement = window.app.translations[window.app.currentLanguage][key];
        }
        
        return replacement;
      });
      
      // æ›´æ–°èŠ‚ç‚¹å†…å®¹
      if (text !== newText) {
        node.textContent = newText;
      }
    }
  });
  
  // æ£€æŸ¥æ˜¯å¦ä»æœ‰æœªæ¸²æŸ“çš„æ¨¡ï¿?
  const stillHasUnrenderedTemplates = document.body.innerHTML.includes('{{') && 
                                     document.body.innerHTML.includes('}}');
  
  if (stillHasUnrenderedTemplates) {
    console.log('ä»æœ‰æœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–Vue');
    
    // æŸ¥æ‰¾åŒ…å«æœªæ¸²æŸ“æ¨¡æ¿çš„å…ƒç´ 
    const elementsWithTemplates = [];
    document.querySelectorAll('*').forEach(el => {
      if (el.innerHTML.includes('{{') && el.innerHTML.includes('}}')) {
        elementsWithTemplates.push(el);
      }
    });
    
    console.log('åŒ…å«æœªæ¸²æŸ“æ¨¡æ¿çš„å…ƒç´ æ•°é‡:', elementsWithTemplates.length);
    
    // å°è¯•ç›´æ¥æ›¿æ¢æ¨¡æ¿å†…å®¹
    elementsWithTemplates.forEach(el => {
      const html = el.innerHTML;
      const newHtml = html.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, function(match, key) {
        fixCount++;
        
        // è·å–ç¿»è¯‘æ–‡æœ¬
        let replacement = key;
        if (window.app.translations && 
            window.app.translations[window.app.currentLanguage] && 
            window.app.translations[window.app.currentLanguage][key]) {
          replacement = window.app.translations[window.app.currentLanguage][key];
        }
        
        return replacement;
      });
      
      if (html !== newHtml) {
        el.innerHTML = newHtml;
      }
    });
  }
  
  console.log(`æ¨¡æ¿ä¿®å¤å®Œæˆï¼Œæ›¿æ¢äº† ${fixCount} ä¸ªæ¨¡æ¿è¡¨è¾¾å¼`);
  return fixCount;
};

// ç›‘å¬DOMå˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°æ·»åŠ çš„æœªæ¸²æŸ“æ¨¡ï¿?
document.addEventListener('DOMContentLoaded', function() {
  // é¦–æ¬¡è¿è¡Œä¿®å¤
  setTimeout(fixTemplateRendering, 500);
  
  // åˆ›å»ºMutationObserverè§‚å¯ŸDOMå˜åŒ–
  const observer = new MutationObserver(function(mutations) {
    let needsFix = false;
    
    // æ£€æŸ¥å˜åŒ–çš„èŠ‚ç‚¹
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes && mutation.addedNodes.length) {
        mutation.addedNodes.forEach(function(node) {
          // æ£€æŸ¥æ–°æ·»åŠ çš„èŠ‚ç‚¹æ˜¯å¦åŒ…å«æœªæ¸²æŸ“çš„æ¨¡ï¿?
          if (node.nodeType === Node.ELEMENT_NODE && 
              node.innerHTML && 
              node.innerHTML.includes('{{') && 
              node.innerHTML.includes('}}')) {
            needsFix = true;
          }
        });
      }
    });
    
    // å¦‚æœæ£€æµ‹åˆ°æœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œå°è¯•ä¿®ï¿?
    if (needsFix) {
      console.log('æ£€æµ‹åˆ°DOMå˜åŒ–ä¸­çš„æœªæ¸²æŸ“æ¨¡æ¿ï¼Œå°è¯•ä¿®å¤');
      fixTemplateRendering();
    }
  });
  
  // å¼€å§‹è§‚å¯Ÿæ•´ä¸ªæ–‡ï¿?
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
}); 

// å®šä¹‰ä¿®å¤æ¨¡æ¿æ¸²æŸ“çš„å‡½ï¿?
function fixTemplateRendering() {
  console.log('æ­£åœ¨æ£€æŸ¥å’Œä¿®å¤æœªæ¸²æŸ“çš„æ¨¡æ¿...');
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¸²æŸ“çš„æ¨¡æ¿
  const hasUnrenderedTemplates = document.body.innerHTML.includes('{{') && 
                                document.body.innerHTML.includes('}}');
  
  if (!hasUnrenderedTemplates) {
    console.log('æ²¡æœ‰å‘ç°æœªæ¸²æŸ“çš„æ¨¡æ¿');
    return 0;
  }
  
  console.log('å‘ç°æœªæ¸²æŸ“çš„æ¨¡æ¿ï¼Œå¼€å§‹ä¿®ï¿?);
  
  // å®šä¹‰ç¿»è¯‘å¯¹è±¡
  const translations = {
    zh: {
      'username': 'ç”¨æˆ·ï¿?,
      'email': 'é‚®ç®±',
      'password': 'å¯†ç ',
      'login': 'ç™»å½•',
      'register': 'æ³¨å†Œ',
      'logout': 'é€€ï¿?,
      'developer': 'å¼€å‘ï¿½?,
      'registerPrompt': 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ',
      'loginPrompt': 'å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»ï¿?,
      'welcome': 'æ¬¢è¿',
      'survey': 'é—®å·',
      'recommendations': 'æ¨è',
      'chat': 'èŠå¤©',
      'evaluation': 'è¯„ä»·',
      'musicPreference': 'éŸ³ä¹åå¥½',
      'submit': 'æäº¤',
      'next': 'ä¸‹ä¸€ï¿?,
      'previous': 'ä¸Šä¸€ï¿?,
      'searchPlaceholder': 'æœç´¢éŸ³ä¹...',
      'songName': 'æ­Œæ›²ï¿?,
      'artist': 'è‰ºæœ¯ï¿?,
      'rating': 'è¯„åˆ†'
    },
    en: {
      'username': 'Username',
      'email': 'Email',
      'password': 'Password',
      'login': 'Login',
      'register': 'Register',
      'logout': 'Logout',
      'developer': 'Developer',
      'registerPrompt': 'No account? Click to register',
      'loginPrompt': 'Already have an account? Click to login',
      'welcome': 'Welcome',
      'survey': 'Survey',
      'recommendations': 'Recommendations',
      'chat': 'Chat',
      'evaluation': 'Evaluation',
      'musicPreference': 'Music Preference',
      'submit': 'Submit',
      'next': 'Next',
      'previous': 'Previous',
      'searchPlaceholder': 'Search music...',
      'songName': 'Song Name',
      'artist': 'Artist',
      'rating': 'Rating'
    }
  };
  
  let fixCount = 0;
  
  // æŸ¥æ‰¾åŒ…å«æœªæ¸²æŸ“æ¨¡æ¿çš„å…ƒç´ 
  const elementsWithTemplates = [];
  document.querySelectorAll('*').forEach(el => {
    if (el.innerHTML && el.innerHTML.includes('{{') && el.innerHTML.includes('}}')) {
      elementsWithTemplates.push(el);
    }
  });
  
  console.log('åŒ…å«æœªæ¸²æŸ“æ¨¡æ¿çš„å…ƒç´ æ•°é‡:', elementsWithTemplates.length);
  
  // è®¾ç½®å½“å‰è¯­è¨€
  const currentLanguage = 'zh'; // é»˜è®¤ä¸­æ–‡
  
  // æ›¿æ¢æ¨¡æ¿
  elementsWithTemplates.forEach(el => {
    const original = el.innerHTML;
    const newHtml = original.replace(/\{\{\s*t\('([^']+)'\)\s*\}\}/g, function(match, key) {
      fixCount++;
      
      // è·å–ç¿»è¯‘æ–‡æœ¬
      let replacement = key;
      if (translations[currentLanguage] && translations[currentLanguage][key]) {
        replacement = translations[currentLanguage][key];
      }
      
      return replacement;
    });
    
    if (original !== newHtml) {
      el.innerHTML = newHtml;
    }
  });
  
  console.log(`æ¨¡æ¿ä¿®å¤å®Œæˆï¼Œæ›¿æ¢äº† ${fixCount} ä¸ªæ¨¡æ¿è¡¨è¾¾å¼`);
  return fixCount;
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œä¿®ï¿?
document.addEventListener('DOMContentLoaded', function() {
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå³å°†å¼€å§‹æ£€æŸ¥æ¨¡æ¿æ¸²ï¿?);
  
  // å»¶è¿Ÿæ‰§è¡Œä¿®å¤ï¼Œç¡®ä¿Vueæœ‰æœºä¼šå…ˆæ¸²æŸ“
  setTimeout(function() {
    const fixedCount = fixTemplateRendering();
    if (fixedCount > 0) {
      console.log(`æˆåŠŸä¿®å¤ï¿?${fixedCount} ä¸ªæ¨¡æ¿è¡¨è¾¾å¼`);
    }
  }, 1000);
}); 


// µ±VueÓ¦ÓÃ¼ÓÔØÍê³Éºó(»òÒ»¶ÎÊ±¼äºó)³õÊ¼»¯ÓÎÏ·
setTimeout(() => {
  initGameWhenCanvasReady();
}, 1000);

